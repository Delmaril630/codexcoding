/*!
 * /*:
 * @target MZ
 * @plugindesc Level, Exp, Attributes
 * @author R.Malizia
 * @url https://rmalizia44.itch.io/
 * @help
 *
 * âš”ï¸ MMORPG Maker Plugin 0.9.3
 *
 * Actors are automatically synced, including key attributes like HP, MP,
 * level, and classes, so players see their characters updated in real time.
 *
 * ðŸ’– Special Thanks to Our Patrons!
 *
 * A huge shout-out to everyone supporting the project through Patreon!
 * Your contributions help keep this plugin alive and growing. Here are
 * the amazing supporters from each tier:
 *
 * ðŸ† Champion Tier
 *
 * - Emerson
 * - little_kaiba
 * - fanao2
 *
 * ðŸŒŸ Legendary Tier
 *
 * - Alexis Naboulet
 * - Ansgar
 * - Samborlini
 * - Georgy
 * - Sephsta
 * - Frapstery
 *
 * âœ¨ Epic Tier
 *
 * - James Shmo
 * - Lupilo
 * - Richard and Adam
 * - Mr.Timbaba
 *
 * @base MMORPG_Client
 * @orderAfter MMORPG_Client
 *
 */(()=>{"use strict";const external_window_namespaceObject=window;const client=window.client;const instance=client;function log(...args){if(true){return}}const src_log=log;function isSameArray(oldArray,newArray){if(oldArray.length!=newArray.length){return false}return oldArray.every((v,i)=>v===newArray[i])}external_window_namespaceObject.Game_Actor.prototype.loaded=function(){return true};external_window_namespaceObject.Game_Actor.prototype.remote=function(){return""};external_window_namespaceObject.Game_Actor.prototype.mustSync=function(){return this.loaded()&&!this._deepCopy&&!this.remote()};external_window_namespaceObject.Game_Actor.prototype.isLeader=function(){return this===external_window_namespaceObject.$gameParty.leader()};external_window_namespaceObject.Game_Actor.prototype.recalcLevel=function(){this._level=0;while(!this.isMaxLevel()&&this.currentExp()>=this.nextLevelExp()){this._level+=1}while(this._level>0&&this.currentExp()<this.currentLevelExp()){this._level-=1}};external_window_namespaceObject.Game_Actor.prototype.dataName=function(){return`actor${this.actorId()}`};external_window_namespaceObject.Game_Actor.prototype.correctedHp=function(){return Math.max(0,Math.min(this.hp,this.mhp))};external_window_namespaceObject.Game_Actor.prototype.correctedMp=function(){return Math.max(0,Math.min(this.mp,this.mmp))};external_window_namespaceObject.Game_Actor.prototype.correctedTp=function(){return Math.max(0,Math.min(this.tp,this.maxTp()))};external_window_namespaceObject.Game_Actor.prototype.onChangeName=function(){instance.save(false,this.dataName(),{name:this._name})};external_window_namespaceObject.Game_Actor.prototype.onChangeNickname=function(){instance.save(false,this.dataName(),{nickname:this._nickname})};external_window_namespaceObject.Game_Actor.prototype.onChangeProfile=function(){instance.save(false,this.dataName(),{profile:this._profile})};external_window_namespaceObject.Game_Actor.prototype.onChangeCharacter=function(){instance.save(false,this.dataName(),{char:[this._characterName,this._characterIndex]})};external_window_namespaceObject.Game_Actor.prototype.onChangeFace=function(){instance.save(false,this.dataName(),{face:[this._faceName,this._faceIndex]})};external_window_namespaceObject.Game_Actor.prototype.onChangeBattler=function(){instance.save(false,this.dataName(),{battler:this._battlerName})};external_window_namespaceObject.Game_Actor.prototype.onChangeClassExp=function(){instance.save(false,this.dataName(),{classId:this._classId,exps:Object.entries(this._exp)})};external_window_namespaceObject.Game_Actor.prototype.onChangeHp=function(){instance.save(false,this.dataName(),{hp:this.correctedHp()})};external_window_namespaceObject.Game_Actor.prototype.onChangeMp=function(){instance.save(false,this.dataName(),{mp:this.correctedMp()})};external_window_namespaceObject.Game_Actor.prototype.onChangeTp=function(){};external_window_namespaceObject.Game_Actor.prototype.onChangeSkills=function(){instance.save(false,this.dataName(),{skills:this._skills})};external_window_namespaceObject.Game_Actor.prototype.onChangeEquips=function(){instance.save(false,this.dataName(),{equips:this._equips.map(e=>e._itemId)})};external_window_namespaceObject.Game_Actor.prototype.onChangeStates=function(){instance.save(false,this.dataName(),{states:this._states})};external_window_namespaceObject.Game_Actor.prototype.onChangeBuffs=function(){};const Game_Actor_setName=external_window_namespaceObject.Game_Actor.prototype.setName;external_window_namespaceObject.Game_Actor.prototype.setName=function(name){const old=this._name;Game_Actor_setName.call(this,name);if(!this.mustSync()){return}if(old===this._name){return}this.onChangeName()};const Game_Actor_setNickname=external_window_namespaceObject.Game_Actor.prototype.setNickname;external_window_namespaceObject.Game_Actor.prototype.setNickname=function(nickname){const old=this._nickname;Game_Actor_setNickname.call(this,nickname);if(!this.mustSync()){return}if(old===this._nickname){return}this.onChangeNickname()};const Game_Actor_setProfile=external_window_namespaceObject.Game_Actor.prototype.setProfile;external_window_namespaceObject.Game_Actor.prototype.setProfile=function(profile){const old=this._profile;Game_Actor_setProfile.call(this,profile);if(!this.mustSync()){return}if(old===this._profile){return}this.onChangeProfile()};const Game_Actor_setCharacterImage=external_window_namespaceObject.Game_Actor.prototype.setCharacterImage;external_window_namespaceObject.Game_Actor.prototype.setCharacterImage=function(characterName,characterIndex){const oldCharacterName=this._characterName;const oldCharacterIndex=this._characterIndex;Game_Actor_setCharacterImage.call(this,characterName,characterIndex);if(!this.mustSync()){return}if(oldCharacterName===this._characterName&&oldCharacterIndex===this._characterIndex){return}this.onChangeCharacter()};const Game_Actor_setFaceImage=external_window_namespaceObject.Game_Actor.prototype.setFaceImage;external_window_namespaceObject.Game_Actor.prototype.setFaceImage=function(faceName,faceIndex){const oldFaceName=this._faceName;const oldFaceIndex=this._faceIndex;Game_Actor_setFaceImage.call(this,faceName,faceIndex);if(!this.mustSync()){return}if(oldFaceName===this._faceName&&oldFaceIndex===this._faceIndex){return}this.onChangeFace()};const Game_Actor_setBattlerImage=external_window_namespaceObject.Game_Actor.prototype.setBattlerImage;external_window_namespaceObject.Game_Actor.prototype.setBattlerImage=function(battlerName){const oldBattlerName=this._battlerName;Game_Actor_setBattlerImage.call(this,battlerName);if(!this.mustSync()){return}if(oldBattlerName===this._battlerName){return}this.onChangeBattler()};const Game_Actor_die=external_window_namespaceObject.Game_Actor.prototype.die;external_window_namespaceObject.Game_Actor.prototype.die=function(){const oldHp=this.correctedHp();Game_Actor_die.call(this);const newHp=this.correctedHp();if(this.mustSync()&&oldHp!==newHp){this.onChangeHp()}};const Game_Actor_revive=external_window_namespaceObject.Game_Actor.prototype.revive;external_window_namespaceObject.Game_Actor.prototype.revive=function(){const oldHp=this.correctedHp();Game_Actor_revive.call(this);const newHp=this.correctedHp();if(this.mustSync()&&oldHp!==newHp){this.onChangeHp()}};const Game_Actor_setHp=external_window_namespaceObject.Game_Actor.prototype.setHp;external_window_namespaceObject.Game_Actor.prototype.setHp=function(hp){const oldHp=this.correctedHp();Game_Actor_setHp.call(this,hp);const newHp=this.correctedHp();if(this.mustSync()&&oldHp!==newHp){this.onChangeHp()}};const Game_Actor_setMp=external_window_namespaceObject.Game_Actor.prototype.setMp;external_window_namespaceObject.Game_Actor.prototype.setMp=function(mp){const oldMp=this.correctedMp();Game_Actor_setMp.call(this,mp);const newMp=this.correctedMp();if(this.mustSync()&&oldMp!==newMp){this.onChangeMp()}};const Game_Actor_setTp=external_window_namespaceObject.Game_Actor.prototype.setTp;external_window_namespaceObject.Game_Actor.prototype.setTp=function(mp){const oldTp=this.correctedTp();Game_Actor_setTp.call(this,mp);const newTp=this.correctedTp();if(this.mustSync()&&oldTp!==newTp){this.onChangeTp()}};const Game_Actor_refresh=external_window_namespaceObject.Game_Actor.prototype.refresh;external_window_namespaceObject.Game_Actor.prototype.refresh=function(){const oldHp=this.correctedHp();const oldMp=this.correctedMp();const oldTp=this.correctedTp();Game_Actor_refresh.call(this);if(!this.mustSync()){return}const newHp=this.correctedHp();const newMp=this.correctedMp();const newTp=this.correctedTp();if(oldHp!==newHp){this.onChangeHp()}if(oldMp!==newMp){this.onChangeMp()}if(oldTp!==newTp){this.onChangeTp()}};const Game_Actor_recoverAll=external_window_namespaceObject.Game_Actor.prototype.recoverAll;external_window_namespaceObject.Game_Actor.prototype.recoverAll=function(){const oldHp=this.correctedHp();const oldMp=this.correctedMp();const oldTp=this.correctedTp();Game_Actor_recoverAll.call(this);if(!this.mustSync()){return}const newHp=this.correctedHp();const newMp=this.correctedMp();const newTp=this.correctedTp();if(oldHp!==newHp){this.onChangeHp()}if(oldMp!==newMp){this.onChangeMp()}if(oldTp!==newTp){this.onChangeTp()}};const Game_Actor_paySkillCost=external_window_namespaceObject.Game_Actor.prototype.paySkillCost;external_window_namespaceObject.Game_Actor.prototype.paySkillCost=function(skill){const oldMp=this.correctedMp();const oldTp=this.correctedTp();Game_Actor_paySkillCost.call(this,skill);if(!this.mustSync()){return}const newMp=this.correctedMp();const newTp=this.correctedTp();if(oldMp!==newMp){this.onChangeMp()}if(oldTp!==newTp){this.onChangeTp()}};const Game_Actor_initExp=external_window_namespaceObject.Game_Actor.prototype.initExp;external_window_namespaceObject.Game_Actor.prototype.initExp=function(){const oldClassId=this._classId;const oldExp=this._exp[this._classId]||0;Game_Actor_initExp.call(this);if(!this.mustSync()){return}const newClassId=this._classId;const newExp=this._exp[this._classId]||0;if(oldClassId===newClassId&&oldExp===newExp){return}this.onChangeClassExp()};const Game_Actor_changeClass=external_window_namespaceObject.Game_Actor.prototype.changeClass;external_window_namespaceObject.Game_Actor.prototype.changeClass=function(classId,keepExp){const oldClassId=this._classId;const oldExp=this._exp[this._classId]||0;Game_Actor_changeClass.call(this,classId,keepExp);if(!this.mustSync()){return}const newClassId=this._classId;const newExp=this._exp[this._classId]||0;if(oldClassId===newClassId&&oldExp===newExp){return}this.onChangeClassExp()};const Game_Actor_changeExp=external_window_namespaceObject.Game_Actor.prototype.changeExp;external_window_namespaceObject.Game_Actor.prototype.changeExp=function(exp,show){const oldClassId=this._classId;const oldExp=this._exp[this._classId]||0;Game_Actor_changeExp.call(this,exp,show);if(!this.mustSync()){return}const newClassId=this._classId;const newExp=this._exp[this._classId]||0;if(oldClassId===newClassId&&oldExp===newExp){return}this.onChangeClassExp()};const Game_Actor_tradeItemWithParty=external_window_namespaceObject.Game_Actor.prototype.tradeItemWithParty;external_window_namespaceObject.Game_Actor.prototype.tradeItemWithParty=function(newItem,oldItem){if(!this.mustSync()){return false}return Game_Actor_tradeItemWithParty.call(this,newItem,oldItem)};const Game_Actor_initEquips=external_window_namespaceObject.Game_Actor.prototype.initEquips;external_window_namespaceObject.Game_Actor.prototype.initEquips=function(equips){src_log("EQUIP: initEquips");const oldEquips=this._equips?this._equips.map(e=>e._itemId):[];Game_Actor_initEquips.call(this,equips);if(!this.mustSync()){return}const newEquips=this._equips.map(e=>e._itemId);if(isSameArray(oldEquips,newEquips)){return}this.onChangeEquips()};const Game_Actor_changeEquip=external_window_namespaceObject.Game_Actor.prototype.changeEquip;external_window_namespaceObject.Game_Actor.prototype.changeEquip=function(slotId,item){src_log("EQUIP: changeEquip");const oldEquips=this._equips.map(e=>e._itemId);Game_Actor_changeEquip.call(this,slotId,item);if(!this.mustSync()){return}const newEquips=this._equips.map(e=>e._itemId);if(isSameArray(oldEquips,newEquips)){return}this.onChangeEquips()};const Game_Actor_forceChangeEquip=external_window_namespaceObject.Game_Actor.prototype.forceChangeEquip;external_window_namespaceObject.Game_Actor.prototype.forceChangeEquip=function(slotId,item){src_log("EQUIP: forceChangeEquip");const oldEquips=this._equips.map(e=>e._itemId);Game_Actor_forceChangeEquip.call(this,slotId,item);if(!this.mustSync()){return}const newEquips=this._equips.map(e=>e._itemId);if(isSameArray(oldEquips,newEquips)){return}this.onChangeEquips()};const Game_Actor_discardEquip=external_window_namespaceObject.Game_Actor.prototype.discardEquip;external_window_namespaceObject.Game_Actor.prototype.discardEquip=function(item){src_log("EQUIP: discardEquip");const oldEquips=this._equips.map(e=>e._itemId);Game_Actor_discardEquip.call(this,item);if(!this.mustSync()){return}const newEquips=this._equips.map(e=>e._itemId);if(isSameArray(oldEquips,newEquips)){return}this.onChangeEquips()};const Game_Actor_releaseUnequippableItems=external_window_namespaceObject.Game_Actor.prototype.releaseUnequippableItems;external_window_namespaceObject.Game_Actor.prototype.releaseUnequippableItems=function(forcing){const oldEquips=this._equips.map(e=>e._itemId);Game_Actor_releaseUnequippableItems.call(this,forcing);if(!this.mustSync()){return}const newEquips=this._equips.map(e=>e._itemId);if(isSameArray(oldEquips,newEquips)){return}this.onChangeEquips()};const Game_Actor_initSkills=external_window_namespaceObject.Game_Actor.prototype.initSkills;external_window_namespaceObject.Game_Actor.prototype.initSkills=function(){const old=this._skills?Array.from(this._skills):[];Game_Actor_initSkills.call(this);if(!this.mustSync()||isSameArray(old,this._skills)){return}this.onChangeSkills()};const Game_Actor_learnSkill=external_window_namespaceObject.Game_Actor.prototype.learnSkill;external_window_namespaceObject.Game_Actor.prototype.learnSkill=function(skillId){const change=!this.isLearnedSkill(skillId);Game_Actor_learnSkill.call(this,skillId);if(!this.mustSync()||!change){return}this.onChangeSkills()};const Game_Actor_forgetSkill=external_window_namespaceObject.Game_Actor.prototype.forgetSkill;external_window_namespaceObject.Game_Actor.prototype.forgetSkill=function(skillId){const change=this.isLearnedSkill(skillId);Game_Actor_forgetSkill.call(this,skillId);if(!this.mustSync()||!change){return}this.onChangeSkills()};const Game_Actor_clearStates=external_window_namespaceObject.Game_Actor.prototype.clearStates;external_window_namespaceObject.Game_Actor.prototype.clearStates=function(){const change=this._states&&this._states.length>0;Game_Actor_clearStates.call(this);if(!this.mustSync()||!change){return}this.onChangeStates()};const Game_Actor_eraseState=external_window_namespaceObject.Game_Actor.prototype.eraseState;external_window_namespaceObject.Game_Actor.prototype.eraseState=function(stateId){const change=this.isStateAffected(stateId);Game_Actor_eraseState.call(this,stateId);if(!this.mustSync()||!change){return}this.onChangeStates()};const Game_Actor_resetStateCounts=external_window_namespaceObject.Game_Actor.prototype.resetStateCounts;external_window_namespaceObject.Game_Actor.prototype.resetStateCounts=function(stateId){const old=this._stateTurns[stateId];Game_Actor_resetStateCounts.call(this,stateId);if(!this.mustSync()||old===this._stateTurns[stateId]){return}this.onChangeStates()};const Game_Actor_updateStateTurns=external_window_namespaceObject.Game_Actor.prototype.updateStateTurns;external_window_namespaceObject.Game_Actor.prototype.updateStateTurns=function(){const change=this._states.some(s=>this._stateTurns[s]>0);Game_Actor_updateStateTurns.call(this);if(!this.mustSync()||!change){return}this.onChangeStates()};const Game_Actor_addNewState=external_window_namespaceObject.Game_Actor.prototype.addNewState;external_window_namespaceObject.Game_Actor.prototype.addNewState=function(stateId){const change=!this.isStateAffected(stateId);Game_Actor_addNewState.call(this,stateId);if(!this.mustSync()||!change){return}this.onChangeStates()};const Game_Actor_clearBuffs=external_window_namespaceObject.Game_Actor.prototype.clearBuffs;external_window_namespaceObject.Game_Actor.prototype.clearBuffs=function(){const change=this._buffs?.some(b=>!!b);Game_Actor_clearBuffs.call(this);if(!this.mustSync()||!change){return}this.onChangeBuffs()};const Game_Actor_eraseBuff=external_window_namespaceObject.Game_Actor.prototype.eraseBuff;external_window_namespaceObject.Game_Actor.prototype.eraseBuff=function(paramId){const change=this.isBuffOrDebuffAffected(paramId);Game_Actor_eraseBuff.call(this,paramId);if(!this.mustSync()||!change){return}this.onChangeBuffs()};const Game_Actor_increaseBuff=external_window_namespaceObject.Game_Actor.prototype.increaseBuff;external_window_namespaceObject.Game_Actor.prototype.increaseBuff=function(paramId){const change=!this.isMaxBuffAffected(paramId);Game_Actor_increaseBuff.call(this,paramId);if(!this.mustSync()||!change){return}this.onChangeBuffs()};const Game_Actor_decreaseBuff=external_window_namespaceObject.Game_Actor.prototype.decreaseBuff;external_window_namespaceObject.Game_Actor.prototype.decreaseBuff=function(paramId){const change=!this.isMaxDebuffAffected(paramId);Game_Actor_decreaseBuff.call(this,paramId);if(!this.mustSync()||!change){return}this.onChangeBuffs()};const Game_Actor_overwriteBuffTurns=external_window_namespaceObject.Game_Actor.prototype.overwriteBuffTurns;external_window_namespaceObject.Game_Actor.prototype.overwriteBuffTurns=function(paramId,turns){const change=this._buffTurns[paramId]<turns;Game_Actor_overwriteBuffTurns.call(this,paramId,turns);if(!this.mustSync()||!change){return}this.onChangeBuffs()};const Game_Actor_updateBuffTurns=external_window_namespaceObject.Game_Actor.prototype.updateBuffTurns;external_window_namespaceObject.Game_Actor.prototype.updateBuffTurns=function(){const change=this._buffTurns.some(b=>b>0);Game_Actor_updateBuffTurns.call(this);if(!this.mustSync()||!change){return}this.onChangeBuffs()};instance.start(false,"actors",async data=>{const promises=[];for(const k in data){const value=data[k];const id=Number(k);if(!Number.isSafeInteger(id)||!value){continue}promises.push(external_window_namespaceObject.$gameActors.fetchAsync(id))}await Promise.all(promises)});class Game_LoadedActor extends external_window_namespaceObject.Game_Actor{_loaded;constructor(actorId){super(actorId);this._loaded=true}loaded(){return!!this._loaded}}window.Game_LoadedActor=Game_LoadedActor;external_window_namespaceObject.Game_Actors.prototype.fetchAsync=async function(id){if(!external_window_namespaceObject.$dataActors[id]){return null}const actor=new Game_LoadedActor(id);this._data[id]=actor;const{name,nickname,profile,char,face,battler,hp,mp,classId,exps,skills,equips,states}=await instance.loadAsync(false,actor.dataName());if(typeof name==="string"){actor._name=name}if(typeof nickname==="string"){actor._nickname=nickname}if(typeof profile==="string"){actor._profile=profile}if(Array.isArray(char)&&typeof char[0]==="string"&&typeof char[1]==="number"){actor._characterName=char[0];actor._characterIndex=char[1]}if(Array.isArray(face)&&typeof face[0]==="string"&&typeof face[1]==="number"){actor._faceName=face[0];actor._faceIndex=face[1]}if(typeof battler==="string"){actor._battlerName=battler}if(typeof hp==="number"){actor._hp=hp}if(typeof mp==="number"){actor._mp=mp}if(typeof classId==="number"){actor._classId=classId}if(Array.isArray(exps)&&exps.every(pair=>Array.isArray(pair))){actor._exp={};for(const exp of exps){const id=Number(exp[0]);const value=Number(exp[1]);if(!Number.isSafeInteger(id)||!Number.isSafeInteger(value)){continue}actor._exp[id]=value}}if(!actor._exp[actor._classId]){actor._exp[actor._classId]=0}if(Array.isArray(skills)&&skills.every(id=>Number.isSafeInteger(id))){actor._skills=Array.from(skills)}if(Array.isArray(equips)){const slots=actor.equipSlots();actor._equips=slots.map(()=>new external_window_namespaceObject.Game_Item);for(let slot=0;slot<slots.length;++slot){const equipId=equips[slot];if(!Number.isSafeInteger(equipId)){continue}const isWeapon=slots[slot]===1;actor._equips[slot].setEquip(isWeapon,equipId)}}if(Array.isArray(states)){actor.clearStates();for(const stateId of states){if(!Number.isSafeInteger(stateId)){continue}actor._states.push(stateId);actor.resetStateCounts(stateId)}}actor.recalcLevel();actor.removeBattleStates();return actor};const Game_Actors_actor=external_window_namespaceObject.Game_Actors.prototype.actor;external_window_namespaceObject.Game_Actors.prototype.actor=function(actorId){if(external_window_namespaceObject.$dataActors[actorId]&&!this._data[actorId]){instance.save(false,"actors",{[actorId]:true})}return Game_Actors_actor.call(this,actorId)};function setParty(members){if(members.length<1){console.error("empty party")}external_window_namespaceObject.$gameParty._actors=members.filter(id=>external_window_namespaceObject.$gameActors.actor(id))}function isSameParty(oldParty,newParty){if(oldParty.length!=newParty.length){return false}return oldParty.every((v,i)=>v===newParty[i])}external_window_namespaceObject.Game_Party.prototype.onChangeMembers=function(){instance.save(false,"party",{members:external_window_namespaceObject.$gameParty._actors})};external_window_namespaceObject.Game_Party.prototype.setupStartingMembers=function(){this._actors=[]};const Game_Party_removeInvalidMembers=external_window_namespaceObject.Game_Party.prototype.removeInvalidMembers;external_window_namespaceObject.Game_Party.prototype.removeInvalidMembers=function(){const oldParty=Array.from(this._actors);Game_Party_removeInvalidMembers.call(this);if(isSameParty(oldParty,external_window_namespaceObject.$gameParty._actors)){return}this.onChangeMembers()};const Game_Party_addActor=external_window_namespaceObject.Game_Party.prototype.addActor;external_window_namespaceObject.Game_Party.prototype.addActor=function(actorId){const oldParty=Array.from(this._actors);Game_Party_addActor.call(this,actorId);if(isSameParty(oldParty,external_window_namespaceObject.$gameParty._actors)){return}this.onChangeMembers()};const Game_Party_removeActor=external_window_namespaceObject.Game_Party.prototype.removeActor;external_window_namespaceObject.Game_Party.prototype.removeActor=function(actorId){const oldParty=Array.from(this._actors);Game_Party_removeActor.call(this,actorId);if(isSameParty(oldParty,external_window_namespaceObject.$gameParty._actors)){return}this.onChangeMembers()};const Game_Party_swapOrder=external_window_namespaceObject.Game_Party.prototype.swapOrder;external_window_namespaceObject.Game_Party.prototype.swapOrder=function(index1,index2){const oldParty=Array.from(this._actors);Game_Party_swapOrder.call(this,index1,index2);if(isSameParty(oldParty,external_window_namespaceObject.$gameParty._actors)){return}this.onChangeMembers()};instance.start(false,"party",data=>{const{members}=data;if(!Array.isArray(members)||members.length<1){setParty(external_window_namespaceObject.$dataSystem.partyMembers)}else{setParty(members.filter(Number.isSafeInteger))}});const Scene_Gameover_start=external_window_namespaceObject.Scene_Gameover.prototype.start;external_window_namespaceObject.Scene_Gameover.prototype.start=function(){Scene_Gameover_start.call(this);for(const m of external_window_namespaceObject.$gameParty.allBattleMembers()){if(m.remote()){continue}m.die();m.refresh()}};external_window_namespaceObject.Game_Actor.prototype.rawSetEquipmentLevel=external_window_namespaceObject.Game_Actor.prototype.setEquipmentLevel;external_window_namespaceObject.Game_Actor.prototype.setEquipmentLevel=function(item,level){if(this._deepCopy||this.remote()){return}const key=item?this.getEquipmentKey(item):null;const oldValue=key?this._equipmentLevels[key]:null;this.rawSetEquipmentLevel(item,level);const newValue=key?this._equipmentLevels[key]:null;if(oldValue===newValue){return}this.onChangeEquipmentLevel(key)};external_window_namespaceObject.Game_Actor.prototype.onChangeEquipmentLevel=function(key){instance.save(false,`equipmentLevel${this.actorId()}`,{[key]:this._equipmentLevels[key]})};const Game_Actors_fetchAsync=external_window_namespaceObject.Game_Actors.prototype.fetchAsync;external_window_namespaceObject.Game_Actors.prototype.fetchAsync=async function(id){const actor=await Game_Actors_fetchAsync.call(this,id);if(actor&&!!actor.rawSetEquipmentLevel&&!!actor.initEquipmentConditions){const equipmentLevels=await instance.loadAsync(false,`equipmentLevel${actor.actorId()}`);for(const[key,level]of Object.entries(equipmentLevels)){const[type,strid]=key.split("_");const id=Number(strid);if(!Number.isSafeInteger(id)||id<1){console.error("invalid equipment id:",key,level);continue}let item;if(type==="Weapon"){item=external_window_namespaceObject.$dataWeapons[id]}else if(type==="Armor"){item=external_window_namespaceObject.$dataArmors[id]}else{console.error("invalid equipment type:",key,level);continue}if(typeof level!=="number"||!Number.isSafeInteger(level)){console.error("invalid equipment level:",key,level);continue}actor.rawSetEquipmentLevel(item,level);actor.initEquipmentConditions(item,true)}actor.refresh()}else{src_log("no equipment level")}return actor};const Myth=window.Myth;function packOrigin(origin){switch(origin){case"learned":return"L";case"equip":return"E";case"state":return"S";case"copy":return"C";case"fusion":return"F";case"empty":return"Z";default:return"?"}}function packCard(card){return packOrigin(card._origin)+card._skillId.toString()}function packCards(cards){if(!cards){return[]}return cards._data.map(packCard)}function packPresets(presets){if(!presets){return[]}return presets.map(c=>[c.name,packCards(c)])}function unpackOrigin(letter){switch(letter){case"L":return"learned";case"E":return"equip";case"S":return"state";case"C":return"copy";case"F":return"fusion";case"Z":return"empty";default:return""}}function unpackCard(cards,pack){if(typeof pack!=="string"){return console.error("invalid myth card:",pack)}const origin=unpackOrigin(pack[0]);const skillId=Number(pack.slice(1));if(!origin){return console.error("invalid myth card origin:",origin,pack)}if(!Number.isSafeInteger(skillId)||skillId<1){return console.error("invalid myth card skillId:",skillId,pack)}const card=cards.push(skillId,origin);external_window_namespaceObject.$gameParty.addCardToLibrary(card)}function unpackCards(cards,packs){cards.clear();for(const pack of packs){unpackCard(cards,pack)}}function unpackPresets(presets,packs){presets.length=0;for(const pair of packs){if(!Array.isArray(pair)){console.error("invalid myth preset pair:",pair,packs);continue}const[name,pack]=pair;if(typeof name!=="string"){console.error("invalid myth preset name:",name,pair,packs);continue}if(!Array.isArray(pack)){console.error("invalid myth preset pack:",pack,pair,packs);continue}const cards=new Game_Cards(name);unpackCards(cards,pack);presets.push(cards)}}function isSameCard(a,b){return a._origin===b._origin&&a._skillId===b._skillId}function isSameCards(oldCards,newCards){if(oldCards.length!=newCards.length){return false}return oldCards.every((c,i)=>isSameCard(c,newCards[i]))}function copyPresets(presets){if(!presets){return[]}return presets.map(c=>[c.name,Array.from(c._data)])}function samePreset(oldPreset,newPreset){const[oldName,oldCards]=oldPreset;const[newName,newCards]=newPreset;return oldName===newName&&isSameCards(oldCards,newCards)}function samePresets(oldPresets,newPresets){if(oldPresets.length!==newPresets.length){return false}return oldPresets.every((old,i)=>samePreset(old,newPresets[i]))}external_window_namespaceObject.Game_Party.prototype.onChangeDeckPresets=function(){const mythDeckPresets=packPresets(this._deckPresets);instance.save(false,"mythCardsParty",{mythDeckPresets})};external_window_namespaceObject.Game_Actor.prototype.mythCardsDataName=function(){return`mythCards${this.actorId()}`};external_window_namespaceObject.Game_Actor.prototype.onChangeSkillCards=function(){const mythSkillCards=packCards(this._skillCards);instance.save(false,this.mythCardsDataName(),{mythSkillCards})};external_window_namespaceObject.Game_Actor.prototype.onChangeCardDeck=function(){const deck=external_window_namespaceObject.$gameParty.inBattle()?this._deckCopy:this._cardDeck;const mythCardDeck=packCards(deck);instance.save(false,this.mythCardsDataName(),{mythCardDeck})};external_window_namespaceObject.Game_Actor.prototype.onChangeDeckPresets=function(){const mythDeckPresets=packPresets(this._deckPresets);instance.save(false,this.mythCardsDataName(),{mythDeckPresets})};external_window_namespaceObject.Game_Actor.prototype.onChangeDeckPresetIndex=function(){const mythDeckPresetIndex=this._deckPresetIndex;instance.save(false,this.mythCardsDataName(),{mythDeckPresetIndex})};if(Myth&&Myth.CGC){const Game_Actor_learnSkill=external_window_namespaceObject.Game_Actor.prototype.learnSkill;external_window_namespaceObject.Game_Actor.prototype.learnSkill=function(skillId){const oldSkillCards=this._skillCards?Array.from(this._skillCards._data):[];const oldCardDeck=this._cardDeck?Array.from(this._cardDeck._data):[];Game_Actor_learnSkill.call(this,skillId);if(!this.mustSync()){return}const newSkillCards=this._skillCards?Array.from(this._skillCards._data):[];const newCardDeck=this._cardDeck?Array.from(this._cardDeck._data):[];if(!isSameCards(oldSkillCards,newSkillCards)){this.onChangeSkillCards()}if(!isSameCards(oldCardDeck,newCardDeck)){this.onChangeCardDeck()}};const Game_Actor_forgetSkill=external_window_namespaceObject.Game_Actor.prototype.forgetSkill;external_window_namespaceObject.Game_Actor.prototype.forgetSkill=function(skillId){const oldSkillCards=this._skillCards?Array.from(this._skillCards._data):[];const oldCardDeck=this._cardDeck?Array.from(this._cardDeck._data):[];Game_Actor_forgetSkill.call(this,skillId);if(!this.mustSync()){return}const newSkillCards=this._skillCards?Array.from(this._skillCards._data):[];const newCardDeck=this._cardDeck?Array.from(this._cardDeck._data):[];if(!isSameCards(oldSkillCards,newSkillCards)){this.onChangeSkillCards()}if(!isSameCards(oldCardDeck,newCardDeck)){this.onChangeCardDeck()}};const Game_Actors_fetchAsync=external_window_namespaceObject.Game_Actors.prototype.fetchAsync;external_window_namespaceObject.Game_Actors.prototype.fetchAsync=async function(id){const actor=await Game_Actors_fetchAsync.call(this,id);if(actor){const{mythSkillCards,mythCardDeck,mythDeckPresets,mythDeckPresetIndex}=await instance.loadAsync(false,actor.mythCardsDataName());if(actor._skillCards&&Array.isArray(mythSkillCards)){unpackCards(actor._skillCards,mythSkillCards)}if(actor._cardDeck&&Array.isArray(mythCardDeck)){unpackCards(actor._cardDeck,mythCardDeck)}if(actor._deckPresets&&Array.isArray(mythDeckPresets)){unpackPresets(actor._deckPresets,mythDeckPresets)}if(typeof mythDeckPresetIndex==="number"){actor._deckPresetIndex=mythDeckPresetIndex}}return actor}}else{src_log("no myth cards base plugin")}if(Myth&&Myth.CGC&&Myth.CGC.Deck){const Myth_addCardToDeck=Myth.CGC.Deck.addCardToDeck;Myth.CGC.Deck.addCardToDeck=function(actorIndex,deckName,skillId,addToLibraryToo){const actor=external_window_namespaceObject.$gameActors.actor(actorIndex);const oldParty=copyPresets(external_window_namespaceObject.$gameParty._deckPresets);const oldActor=copyPresets(actor?._deckPresets);Myth_addCardToDeck.call(this,actorIndex,deckName,skillId,addToLibraryToo);if(!actor||!actor.mustSync()){return}const newParty=copyPresets(external_window_namespaceObject.$gameParty._deckPresets);const newActor=copyPresets(actor._deckPresets);if(!samePresets(oldParty,newParty)){external_window_namespaceObject.$gameParty.onChangeDeckPresets()}if(!samePresets(oldActor,newActor)){actor.onChangeDeckPresets()}};const Myth_removeCardFromDeck=Myth.CGC.Deck.removeCardFromDeck;Myth.CGC.Deck.removeCardFromDeck=function(actorIndex,deckName,skillId,removeFromLibraryToo){const actor=external_window_namespaceObject.$gameActors.actor(actorIndex);const oldParty=copyPresets(external_window_namespaceObject.$gameParty._deckPresets);const oldActor=copyPresets(actor?._deckPresets);Myth_removeCardFromDeck.call(this,actorIndex,deckName,skillId,removeFromLibraryToo);if(!actor||!actor.mustSync()){return}const newParty=copyPresets(external_window_namespaceObject.$gameParty._deckPresets);const newActor=copyPresets(actor._deckPresets);if(!samePresets(oldParty,newParty)){external_window_namespaceObject.$gameParty.onChangeDeckPresets()}if(!samePresets(oldActor,newActor)){actor.onChangeDeckPresets()}};const Scene_DeckEditor_addCardToDeck=Scene_DeckEditor.prototype.addCardToDeck;Scene_DeckEditor.prototype.addCardToDeck=function(){const actor=this.actor();const oldParty=copyPresets(external_window_namespaceObject.$gameParty._deckPresets);const oldActor=copyPresets(actor?._deckPresets);Scene_DeckEditor_addCardToDeck.call(this);if(!actor||!actor.mustSync()){return}const newParty=copyPresets(external_window_namespaceObject.$gameParty._deckPresets);const newActor=copyPresets(actor._deckPresets);if(!samePresets(oldParty,newParty)){external_window_namespaceObject.$gameParty.onChangeDeckPresets()}if(!samePresets(oldActor,newActor)){actor.onChangeDeckPresets()}};const Scene_DeckEditor_removeCardFromDeck=Scene_DeckEditor.prototype.removeCardFromDeck;Scene_DeckEditor.prototype.removeCardFromDeck=function(){const actor=this.actor();const oldParty=copyPresets(external_window_namespaceObject.$gameParty._deckPresets);const oldActor=copyPresets(actor?._deckPresets);Scene_DeckEditor_removeCardFromDeck.call(this);if(!actor||!actor.mustSync()){return}const newParty=copyPresets(external_window_namespaceObject.$gameParty._deckPresets);const newActor=copyPresets(actor._deckPresets);if(!samePresets(oldParty,newParty)){external_window_namespaceObject.$gameParty.onChangeDeckPresets()}if(!samePresets(oldActor,newActor)){actor.onChangeDeckPresets()}};const Scene_DeckSelector_onNameInputOk=Scene_DeckSelector.prototype.onNameInputOk;Scene_DeckSelector.prototype.onNameInputOk=function(){const actor=this.actor();const oldParty=copyPresets(external_window_namespaceObject.$gameParty._deckPresets);const oldActor=copyPresets(actor?._deckPresets);Scene_DeckSelector_onNameInputOk.call(this);if(!actor||!actor.mustSync()){return}const newParty=copyPresets(external_window_namespaceObject.$gameParty._deckPresets);const newActor=copyPresets(actor._deckPresets);if(!samePresets(oldParty,newParty)){external_window_namespaceObject.$gameParty.onChangeDeckPresets()}if(!samePresets(oldActor,newActor)){actor.onChangeDeckPresets()}};const Game_Actor_equipDeck=external_window_namespaceObject.Game_Actor.prototype.equipDeck;external_window_namespaceObject.Game_Actor.prototype.equipDeck=function(index){const oldCardDeck=this._cardDeck?Array.from(this._cardDeck._data):[];const oldDeckPresetIndex=this._deckPresetIndex;Game_Actor_equipDeck.call(this,index);if(!this.mustSync()){return}const newCardDeck=this._cardDeck?Array.from(this._cardDeck._data):[];const newDeckPresetIndex=this._deckPresetIndex;if(!isSameCards(oldCardDeck,newCardDeck)){this.onChangeCardDeck()}if(oldDeckPresetIndex!==newDeckPresetIndex){this.onChangeDeckPresetIndex()}};const Game_Actor_createDeck=external_window_namespaceObject.Game_Actor.prototype.createDeck;external_window_namespaceObject.Game_Actor.prototype.createDeck=function(){const oldParty=copyPresets(external_window_namespaceObject.$gameParty._deckPresets);const oldActor=copyPresets(this._deckPresets);Game_Actor_createDeck.call(this);if(!this.mustSync()){return}const newParty=copyPresets(external_window_namespaceObject.$gameParty._deckPresets);const newActor=copyPresets(this._deckPresets);if(!samePresets(oldParty,newParty)){external_window_namespaceObject.$gameParty.onChangeDeckPresets()}if(!samePresets(oldActor,newActor)){this.onChangeDeckPresets()}};const Game_Actor_copyDeck=external_window_namespaceObject.Game_Actor.prototype.copyDeck;external_window_namespaceObject.Game_Actor.prototype.copyDeck=function(originalIndex){const oldParty=copyPresets(external_window_namespaceObject.$gameParty._deckPresets);const oldActor=copyPresets(this._deckPresets);const oldDeckPresetIndex=this._deckPresetIndex;Game_Actor_copyDeck.call(this,originalIndex);if(!this.mustSync()){return}const newParty=copyPresets(external_window_namespaceObject.$gameParty._deckPresets);const newActor=copyPresets(this._deckPresets);const newDeckPresetIndex=this._deckPresetIndex;if(!samePresets(oldParty,newParty)){external_window_namespaceObject.$gameParty.onChangeDeckPresets()}if(!samePresets(oldActor,newActor)){this.onChangeDeckPresets()}if(oldDeckPresetIndex!==newDeckPresetIndex){this.onChangeDeckPresetIndex()}};const Game_Actor_deleteDeck=external_window_namespaceObject.Game_Actor.prototype.deleteDeck;external_window_namespaceObject.Game_Actor.prototype.deleteDeck=function(deckIndex){const oldParty=copyPresets(external_window_namespaceObject.$gameParty._deckPresets);const oldActor=copyPresets(this._deckPresets);const oldDeckPresetIndex=this._deckPresetIndex;Game_Actor_deleteDeck.call(this,deckIndex);if(!this.mustSync()){return}const newParty=copyPresets(external_window_namespaceObject.$gameParty._deckPresets);const newActor=copyPresets(this._deckPresets);const newDeckPresetIndex=this._deckPresetIndex;if(!samePresets(oldParty,newParty)){external_window_namespaceObject.$gameParty.onChangeDeckPresets()}if(!samePresets(oldActor,newActor)){this.onChangeDeckPresets()}if(oldDeckPresetIndex!==newDeckPresetIndex){this.onChangeDeckPresetIndex()}};const Game_Party_addActor=external_window_namespaceObject.Game_Party.prototype.addActor;external_window_namespaceObject.Game_Party.prototype.addActor=function(actorId){const oldParty=copyPresets(this._deckPresets);Game_Party_addActor.call(this,actorId);const newParty=copyPresets(this._deckPresets);if(!samePresets(oldParty,newParty)){this.onChangeDeckPresets()}};instance.start(false,"mythCardsParty",data=>{const{mythDeckPresets}=data;if(external_window_namespaceObject.$gameParty._deckPresets&&mythDeckPresets&&Array.isArray(mythDeckPresets)){unpackPresets(external_window_namespaceObject.$gameParty._deckPresets,mythDeckPresets)}})}else{src_log("no myth cards base plugin")}const Game_System_addTimesEnemySeen=external_window_namespaceObject.Game_System.prototype.addTimesEnemySeen;external_window_namespaceObject.Game_System.prototype.addTimesEnemySeen=function(id,ammount){const oldValue=this._timesEnemySeen[id];Game_System_addTimesEnemySeen.call(this,id,ammount);const newValue=this._timesEnemySeen[id];if(oldValue!==newValue){instance.save(false,"visuBestSee",{[id]:newValue})}};const Game_System_addTimesEnemyDefeated=external_window_namespaceObject.Game_System.prototype.addTimesEnemyDefeated;external_window_namespaceObject.Game_System.prototype.addTimesEnemyDefeated=function(id,ammount){const oldValue=this._timesEnemyDefeated[id];Game_System_addTimesEnemyDefeated.call(this,id,ammount);const newValue=this._timesEnemyDefeated[id];if(oldValue!==newValue){instance.save(false,"visuBestDef",{[id]:newValue})}};instance.start(false,"visuBestSee",data=>{const seen=[];for(const key in data){const id=Number(key);const value=data[id];if(typeof id!=="number"||!Number.isInteger(id)){console.error("invalid bestiary seen id:",id,value);continue}if(typeof value!=="number"||!Number.isInteger(value)){console.error("invalid bestiary seen value:",id,value);continue}seen.push([id,value])}external_window_namespaceObject.$gameSystem._timesEnemySeen=Object.fromEntries(seen);external_window_namespaceObject.$gameSystem._defeatedEnemies=seen.filter(([k,v])=>v>0).map(([k,v])=>k)});instance.start(false,"visuBestDef",data=>{const defeated=[];for(const key in data){const id=Number(key);const value=data[id];if(typeof id!=="number"||!Number.isInteger(id)){console.error("invalid bestiary defeated id:",id,value);continue}if(typeof value!=="number"||!Number.isInteger(value)){console.error("invalid bestiary defeated value:",id,value);continue}defeated.push([id,value])}external_window_namespaceObject.$gameSystem._timesEnemyDefeated=Object.fromEntries(defeated)});const JsonEx_makeDeepCopy=external_window_namespaceObject.JsonEx.makeDeepCopy;external_window_namespaceObject.JsonEx.makeDeepCopy=function(object){const result=JsonEx_makeDeepCopy.call(this,object);Object.setPrototypeOf(result,Object.getPrototypeOf(object));result._deepCopy=true;return result}})();