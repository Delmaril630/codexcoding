/*!
 * /*:
 * @target MZ
 * @plugindesc Movement, Skin - Fixed for DotMove and Interaction Names
 * @author R.Malizia (Modded)
 * @url https://rmalizia44.itch.io/
 * @help
 *
 * ⚔️ MMORPG Maker Plugin 0.9.4 (Fixes Applied)
 *
 * Maps with <Sync> added to their note field allow players to interact
 * and see each other, creating shared online areas. Maps without <Sync>
 * in the note field are treated as solo instances for each player.
 *
 * Followers are also synced, allowing players to see each other's followers
 * in real time. This functionality can even support pet systems, giving
 * developers more creative options for gameplay.
 *
 * @base MMORPG_Client
 * @orderAfter MMORPG_Client
 *
 * @base MMORPG_Actors
 * @orderAfter MMORPG_Actors
 *
 * @param showLoginName
 * @text Show Login Name
 * @type boolean
 * @desc Show User Login as Name
 * @default false
 *
 */(()=>{"use strict";const external_window_namespaceObject=window;function isValidMapId(id){if(typeof id!=="number"){return false}if(!Number.isSafeInteger(id)){return false}if(id<1){return false}if(external_window_namespaceObject.$dataMapInfos&&id>=external_window_namespaceObject.$dataMapInfos.length){return false}return true}function isValidEventId(id){if(typeof id!=="number"){return false}if(!Number.isSafeInteger(id)){return false}if(id<1){return false}if($gameMap&&!$gameMap.event(id)){return false}return true}function isValidPosition(x,y,dir){if(!Number.isSafeInteger(x)){return false}if(!Number.isSafeInteger(y)){return false}if(!Number.isSafeInteger(dir)||dir<1||dir>9){return false}if($gameMap&&!$gameMap.isValid(x,y)){return false}return true}function isValidMove(x,y,dir){if(!isValidPosition(x,y,dir)){return false}return true}function isValidJump(x,y,dir){if(!isValidPosition(x,y,dir)){return false}return true}const client=window.client;const instance=client;function log(...args){if(true){return}}const src_log=log;const Game_Actor_setCharacterImage=external_window_namespaceObject.Game_Actor.prototype.setCharacterImage;external_window_namespaceObject.Game_Actor.prototype.setCharacterImage=function(characterName,characterIndex){const oldCharacterName=this._characterName;const oldCharacterIndex=this._characterIndex;Game_Actor_setCharacterImage.call(this,characterName,characterIndex);if(!external_window_namespaceObject.$gameParty.battleMembers().includes(this)){return}if(oldCharacterName===this._characterName&&oldCharacterIndex===this._characterIndex){return}external_window_namespaceObject.$gamePlayer.refresh();external_window_namespaceObject.$gamePlayer.publishSkins()};const Game_Actor_onChangeName=external_window_namespaceObject.Game_Actor.prototype.onChangeName;external_window_namespaceObject.Game_Actor.prototype.onChangeName=function(){Game_Actor_onChangeName.call(this);if(!this.isLeader()){return}external_window_namespaceObject.$gamePlayer.publishInfo()};const Game_Actor_onChangeProfile=external_window_namespaceObject.Game_Actor.prototype.onChangeProfile;external_window_namespaceObject.Game_Actor.prototype.onChangeProfile=function(){Game_Actor_onChangeProfile.call(this);if(!this.isLeader()){return}external_window_namespaceObject.$gamePlayer.publishInfo()};const Game_Actor_onChangeFace=external_window_namespaceObject.Game_Actor.prototype.onChangeFace;external_window_namespaceObject.Game_Actor.prototype.onChangeFace=function(){Game_Actor_onChangeFace.call(this);if(!this.isLeader()){return}external_window_namespaceObject.$gamePlayer.publishInfo()};const Game_Actor_onChangeClassExp=external_window_namespaceObject.Game_Actor.prototype.onChangeClassExp;external_window_namespaceObject.Game_Actor.prototype.onChangeClassExp=function(){Game_Actor_onChangeClassExp.call(this);if(!this.isLeader()){return}external_window_namespaceObject.$gamePlayer.publishInfo()};external_window_namespaceObject.Game_CharacterBase.prototype.remote=function(){return""};
 
 // FIX: Normalize direction for DotMoveSystem compatibility
 external_window_namespaceObject.Game_CharacterBase.prototype.packChar=function(){
   let d = this.direction();
   // Convert diagonals to standard 4-dir to prevent client flipping
   if (d === 1) d = 2;
   if (d === 3) d = 6;
   if (d === 7) d = 4;
   if (d === 9) d = 8;
   return{x:this.x,y:this.y,d:Math.floor(d),s:this.realMoveSpeed()}
 };
 
 external_window_namespaceObject.Game_CharacterBase.prototype.packSkin=function(){return{n:this.characterName(),i:this.characterIndex()}};external_window_namespaceObject.Game_CharacterBase.prototype.setChar=function(char){const{x,y,d,s,m,j}=char;if(typeof x!="number"){console.error("invalid x");return false}if(typeof y!="number"){console.error("invalid y");return false}if(typeof d!="number"){console.error("invalid d");return false}if(typeof s!="number"){console.error("invalid s");return false}this.setMoveSpeed(s);this.setDirection(d);if(external_window_namespaceObject.SceneManager._scene instanceof external_window_namespaceObject.Scene_Map){if(j){this.jump(x-this.x,y-this.y);return true}const distance=external_window_namespaceObject.$gameMap.distance(this._realX,this._realY,x,y);if(m&&distance<3){this._x=x;this._y=y;return true}}this.locate(x,y);return true};external_window_namespaceObject.Game_CharacterBase.prototype.setSkin=function(skin){const{n,i}=skin;if(typeof n!="string"){console.error("invalid n");return false}if(typeof i!="number"){console.error("invalid i");return false}this.setImage(n,i);return true};class Game_RemoteFollower extends external_window_namespaceObject.Game_Character{_leader;constructor(leader){super();this._leader=leader}realMoveSpeed(){return this._leader.realMoveSpeed()}update(){super.update();this.setMoveSpeed(this._leader.realMoveSpeed());this.setOpacity(this._leader.opacity());this.setBlendMode(this._leader.blendMode());this.setWalkAnime(this._leader.hasWalkAnime());this.setStepAnime(this._leader.hasStepAnime());this.setDirectionFix(this._leader.isDirectionFixed());this.setTransparent(this._leader.isTransparent())}}class Game_RemoteEvent extends external_window_namespaceObject.Game_Character{_remote;_followers=new Array;faceName="";faceIndex=0;name="";level=0;className="";nickname="";profile="";constructor(remote){super();this._remote=remote;for(let i=1;i<external_window_namespaceObject.$gameParty.maxBattleMembers();++i){this._followers.push(new Game_RemoteFollower(this))}}remote(){return this._remote}followers(){return this._followers}isTriggerIn(triggers){return false}update(){super.update();for(const follower of this._followers){follower.update()}}party(){const leader=this;return[leader].concat(this._followers)}setChars(chars){const party=this.party();for(let i=0;i<chars.length;++i){const character=party[i];if(!character){return false}if(!character.setChar(chars[i])){return false}}return true}setSkins(skins){const party=this.party();for(let i=0;i<skins.length;++i){const character=party[i];if(!character){return false}if(!character.setSkin(skins[i])){return false}}return true}}external_window_namespaceObject.Game_Map.prototype.remotes=function(){if(!this._remotes){this._remotes=new Map}return this._remotes};external_window_namespaceObject.Game_Map.prototype.clearRemotes=function(){this.remotes().clear()};external_window_namespaceObject.Game_Map.prototype.hasRemote=function(name){return this.remotes().has(name)};external_window_namespaceObject.Game_Map.prototype.getRemote=function(name){return this.remotes().get(name)};external_window_namespaceObject.Game_Map.prototype.reqRemote=function(name){let event=this.getRemote(name);if(!event){event=new Game_RemoteEvent(name);this.remotes().set(name,event)}return event};external_window_namespaceObject.Game_Map.prototype.delRemote=function(name){this.remotes().delete(name)};external_window_namespaceObject.Game_Map.prototype.syncType=function(){const data=external_window_namespaceObject.$dataMap;if(!data){return""}const keys=Object.keys(data.meta);return this.syncFind(keys)};external_window_namespaceObject.Game_Map.prototype.syncName=function(){return external_window_namespaceObject.$gameMap.mapId().toString()};external_window_namespaceObject.Game_Map.prototype.syncFind=function(keys){if(keys.some(k=>k.toLowerCase()==="sync")){return"sync"}return""};const Game_Map_setup=external_window_namespaceObject.Game_Map.prototype.setup;external_window_namespaceObject.Game_Map.prototype.setup=function(mapId){Game_Map_setup.call(this,mapId);this.clearRemotes()};const Game_Map_update=external_window_namespaceObject.Game_Map.prototype.update;external_window_namespaceObject.Game_Map.prototype.update=function(sceneActive){Game_Map_update.call(this,sceneActive);this.remotes().forEach(e=>e.update())};function sameActorArray(a,b){return a.length==b.length&&a.every((a,i)=>a==b[i])}external_window_namespaceObject.Game_Party.prototype.leaderName=function(){return this.leader()?._name||""};const Game_Party_addActor=external_window_namespaceObject.Game_Party.prototype.addActor;external_window_namespaceObject.Game_Party.prototype.addActor=function(actorId){const oldChars=Array.from(this.battleMembers());Game_Party_addActor.call(this,actorId);const newChars=Array.from(this.battleMembers());if(sameActorArray(oldChars,newChars)){return}external_window_namespaceObject.$gamePlayer.publishSkins()};const Game_Party_removeActor=external_window_namespaceObject.Game_Party.prototype.removeActor;external_window_namespaceObject.Game_Party.prototype.removeActor=function(actorId){const oldChars=Array.from(this.battleMembers());Game_Party_removeActor.call(this,actorId);const newChars=Array.from(this.battleMembers());if(sameActorArray(oldChars,newChars)){return}external_window_namespaceObject.$gamePlayer.publishSkins()};const Game_Party_swapOrder=external_window_namespaceObject.Game_Party.prototype.swapOrder;external_window_namespaceObject.Game_Party.prototype.swapOrder=function(index1,index2){const oldChars=Array.from(this.battleMembers());Game_Party_swapOrder.call(this,index1,index2);const newChars=Array.from(this.battleMembers());if(sameActorArray(oldChars,newChars)){return}external_window_namespaceObject.$gamePlayer.publishSkins()};external_window_namespaceObject.Game_Player.prototype.partyChars=function(){let all=[this];if(external_window_namespaceObject.$dataSystem.optFollowers){all=all.concat(this.followers().visibleFollowers())}return all};external_window_namespaceObject.Game_Player.prototype.partyActors=function(){let all=[external_window_namespaceObject.$gameParty.leader()];if(external_window_namespaceObject.$dataSystem.optFollowers){all=all.concat(this.followers().visibleFollowers().map(f=>f.actor()))}return all};external_window_namespaceObject.Game_Player.prototype.getInfo=function(){const leader=external_window_namespaceObject.$gameParty.leader();return[leader.faceName(),leader.faceIndex(),leader.name(),leader.level,leader.currentClass().name,leader.profile(),this.partyActors().map(a=>a?.actor()?.meta)]};external_window_namespaceObject.Game_Player.prototype.packChars=function(){const all=this.partyChars();return all.map(c=>c.packChar())};external_window_namespaceObject.Game_Player.prototype.packSkins=function(){const all=this.partyChars();return all.map(c=>c.packSkin())};external_window_namespaceObject.Game_Player.prototype.sendInfo=function(user){instance.sendto(user,"info",external_window_namespaceObject.$gameMap.mapId(),...this.getInfo())};external_window_namespaceObject.Game_Player.prototype.sendChars=function(user){instance.sendto(user,"char",external_window_namespaceObject.$gameMap.mapId(),this.packChars())};external_window_namespaceObject.Game_Player.prototype.sendSkins=function(user){instance.sendto(user,"skin",external_window_namespaceObject.$gameMap.mapId(),this.packSkins())};external_window_namespaceObject.Game_Player.prototype.publishSkins=function(){if(!this._subscribed){return}instance.publish(false,"map","skin",external_window_namespaceObject.$gameMap.mapId(),this.packSkins())};external_window_namespaceObject.Game_Player.prototype.publishInfo=function(){if(!this._subscribed){return}instance.publish(false,"map","info",external_window_namespaceObject.$gameMap.mapId(),...this.getInfo())};external_window_namespaceObject.Game_Player.prototype.publishMoves=function(){if(!this._subscribed){return}const chars=this.packChars().map(c=>({m:true,...c}));instance.publish(false,"map","char",external_window_namespaceObject.$gameMap.mapId(),chars)};external_window_namespaceObject.Game_Player.prototype.publishJumps=function(){if(!this._subscribed){return}const chars=this.packChars().map(c=>({j:true,...c}));instance.publish(false,"map","char",external_window_namespaceObject.$gameMap.mapId(),chars)};external_window_namespaceObject.Game_Player.prototype.savePosition=function(){instance.save(false,"char",{map:external_window_namespaceObject.$gameMap.mapId(),x:this.x,y:this.y})};const Game_Player_performTransfer=external_window_namespaceObject.Game_Player.prototype.performTransfer;external_window_namespaceObject.Game_Player.prototype.performTransfer=function(){Game_Player_performTransfer.call(this);const type=external_window_namespaceObject.$gameMap.syncType();const name=external_window_namespaceObject.$gameMap.syncName();if(type&&name){instance.subscribe("map",type+name,external_window_namespaceObject.$gameParty.leaderName());this._subscribed=true}else{instance.subscribe("map",null);this._subscribed=false}this.savePosition()};const Game_Player_moveStraight=external_window_namespaceObject.Game_Player.prototype.moveStraight;external_window_namespaceObject.Game_Player.prototype.moveStraight=function(d){const oldX=this.x;const oldY=this.y;const oldDir=this.direction();Game_Player_moveStraight.call(this,d);const x=this.x;const y=this.y;const dir=this.direction();if(oldX!==x||oldY!==y||oldDir!==dir){this.publishMoves()}if(oldX!==x||oldY!==y){this.savePosition()}};const Game_Player_moveDiagonally=external_window_namespaceObject.Game_Player.prototype.moveDiagonally;external_window_namespaceObject.Game_Player.prototype.moveDiagonally=function(horz,vert){const oldX=this.x;const oldY=this.y;const oldDir=this.direction();Game_Player_moveDiagonally.call(this,horz,vert);const x=this.x;const y=this.y;const dir=this.direction();if(oldX!==x||oldY!==y||oldDir!==dir){this.publishMoves()}if(oldX!==x||oldY!==y){this.savePosition()}};const Game_Player_jump=external_window_namespaceObject.Game_Player.prototype.jump;external_window_namespaceObject.Game_Player.prototype.jump=function(xPlus,yPlus){Game_Player_jump.call(this,xPlus,yPlus);this.publishJumps();this.savePosition()};function setInteraction(key,callback){if(!window._interaction){window._interaction=new Map}window._interaction.set(key,callback)}window.setInteraction=setInteraction;function getInteraction(key){if(!window._interaction){return onInvalid.bind(null,key)}const callback=window._interaction.get(key);if(!callback){return onInvalid.bind(null,key)}return callback}function onInvalid(key,user,name){src_log("invalid interaction:",key,user,name)}function showLoginName(){return external_window_namespaceObject.PluginManager.parameters("MMORPG_Characters")["showLoginName"]=="true"}

// FIX: Interaction Logic using correct name priority
function onInteraction(user,event){
  const interaction=window._interaction;
  if(!interaction||interaction.size<1){src_log("no interaction registered");return}
  if(external_window_namespaceObject.$gameMessage.isBusy()){return}
  let names=Array.from(interaction.keys());
  const canGuildInvite = (window.Guild && typeof Guild.canInvite === 'function' && Guild.canInvite());
  if (!canGuildInvite) {
    names = names.filter(k => k !== 'Guild Invite');
  } else {
    const gi = names.indexOf('Guild Invite');
    if (gi > 0) {
      names.splice(gi, 1);
      names.unshift('Guild Invite');
    }
  }
  names = names.slice(0, 8);
  external_window_namespaceObject.$gameMessage.setFaceImage(event.faceName,event.faceIndex);
  
  // FIX: Use event.name if available, otherwise fallback to user ID if showLoginName is true
  const displayName = event.name || (showLoginName() ? user : "Unknown");
  external_window_namespaceObject.$gameMessage.setSpeakerName(displayName);
  
  external_window_namespaceObject.$gameMessage.add(`${external_window_namespaceObject.TextManager.level} ${event.level}`);
  external_window_namespaceObject.$gameMessage.add(event.className);
  external_window_namespaceObject.$gameMessage.add(event.profile);
  external_window_namespaceObject.$gameMessage.setChoices(names,0,-2);
  external_window_namespaceObject.$gameMessage.setChoiceCallback(index=>{
    // Pass both user ID and Display Name to the callback
    getInteraction(names[index])(user, displayName)
  })
}

const Game_Player_startMapEvent=external_window_namespaceObject.Game_Player.prototype.startMapEvent;external_window_namespaceObject.Game_Player.prototype.startMapEvent=function(x,y,triggers,normal){Game_Player_startMapEvent.call(this,x,y,triggers,normal);if(external_window_namespaceObject.$gameMap.isEventRunning()){return}for(const[user,event]of external_window_namespaceObject.$gameMap.remotes()){if(!event.pos(x,y)||!triggers.includes(0)){continue}return onInteraction(user,event)}};external_window_namespaceObject.Sprite_Character.prototype.remote=function(){return this._character.remote()};const mz3d=window.mz3d;class Sprite_RemoteCharacter extends external_window_namespaceObject.Sprite_Character{_mz3d;constructor(character){super(character);if(mz3d){this._mz3d=mz3d.createCharacterFor(character,0)}}destroy(options){if(mz3d&&this._mz3d){if(mz3d.characters.indexOf(this._mz3d)>=0){delete this._mz3d.char.mv3d_sprite;this._mz3d.dispose(false,true)}this._mz3d=undefined}return super.destroy(options)}}class Sprite_RemotePlayer extends Sprite_RemoteCharacter{_followers;constructor(character,followers){super(character);this._followers=followers}followers(){return this._followers}}external_window_namespaceObject.Spriteset_Map.prototype.remotes=function(){if(!this._remotes){this._remotes=new Map}return this._remotes};external_window_namespaceObject.Spriteset_Map.prototype.clearRemotes=function(){for(const[name,remote]of this.remotes()){remote.destroy()}this.remotes().clear()};external_window_namespaceObject.Spriteset_Map.prototype.hasRemote=function(name){return this.remotes().has(name)};external_window_namespaceObject.Spriteset_Map.prototype.reqRemote=function(name){let sprite=this.remotes().get(name);if(!sprite){const character=external_window_namespaceObject.$gameMap.reqRemote(name);const followers=Array.from(character.followers()).reverse().map(f=>new Sprite_RemoteCharacter(f));sprite=new Sprite_RemotePlayer(character,followers);for(const follower of sprite.followers()){this._tilemap.addChild(follower)}this._characterSprites.push(sprite);this._tilemap.addChild(sprite);this.remotes().set(name,sprite)}return sprite};external_window_namespaceObject.Spriteset_Map.prototype.delRemote=function(name){const sprite=this.remotes().get(name);if(sprite){sprite.destroy();for(const follower of sprite.followers()){follower.destroy()}}this.remotes().delete(name)};const Spriteset_Map_createCharacters=external_window_namespaceObject.Spriteset_Map.prototype.createCharacters;external_window_namespaceObject.Spriteset_Map.prototype.createCharacters=function(){Spriteset_Map_createCharacters.call(this);this.clearRemotes();for(const[name,character]of external_window_namespaceObject.$gameMap.remotes()){this.reqRemote(name)}};const Spriteset_Map_hideCharacters=external_window_namespaceObject.Spriteset_Map.prototype.hideCharacters;external_window_namespaceObject.Spriteset_Map.prototype.hideCharacters=function(){Spriteset_Map_hideCharacters.call(this);for(const[_,remote]of this.remotes()){remote.hide();for(const follower of remote.followers()){follower.hide()}}};const Spriteset_Map_findTargetSprite=external_window_namespaceObject.Spriteset_Map.prototype.findTargetSprite;external_window_namespaceObject.Spriteset_Map.prototype.findTargetSprite=function(target){for(const[name,sprite]of this.remotes()){if(sprite.checkCharacter(target)){return sprite}}return Spriteset_Map_findTargetSprite.call(this,target)};function isValidChars(chars){return Array.isArray(chars)&&chars.every(p=>!!p&&typeof p==="object")}function isValidSkins(skins){return Array.isArray(skins)&&skins.every(p=>!!p&&typeof p==="object")}instance.start(false,"char",data=>{const{map,x,y}=data;if(typeof map!=="number"||typeof x!=="number"||typeof y!=="number"){return src_log("no coords")}external_window_namespaceObject.$gamePlayer.reserveTransfer(map,x,y,2,0)});instance.react(external_window_namespaceObject.Scene_Base,"map","+",(scene,from)=>{instance.sendto(from,"whois");external_window_namespaceObject.$gamePlayer.sendInfo(from);external_window_namespaceObject.$gamePlayer.sendChars(from);external_window_namespaceObject.$gamePlayer.sendSkins(from)});instance.react(external_window_namespaceObject.Scene_Base,"map","-",(scene,from)=>{if(scene instanceof external_window_namespaceObject.Scene_Map){scene._spriteset.delRemote(from)}external_window_namespaceObject.$gameMap.delRemote(from)});instance.react(external_window_namespaceObject.Scene_Base,"@","whois",(scene,from)=>{external_window_namespaceObject.$gamePlayer.sendInfo(from);external_window_namespaceObject.$gamePlayer.sendChars(from);external_window_namespaceObject.$gamePlayer.sendSkins(from)});instance.react(external_window_namespaceObject.Scene_Base,["@","map"],"info",(scene,from,mapId,faceName,faceIndex,name,level,className,profile,meta)=>{if(!isValidMapId(mapId)){return instance.report(from,"info invalid map")}if(typeof faceName!=="string"){return instance.report(from,"info invalid faceName")}if(typeof faceIndex!=="number"||!Number.isSafeInteger(faceIndex)){return instance.report(from,"info invalid faceIndex")}if(typeof name!=="string"){return instance.report(from,"info invalid name")}if(typeof level!=="number"||!Number.isSafeInteger(level)){return instance.report(from,"info invalid level")}if(typeof className!=="string"){return instance.report(from,"info invalid className")}if(typeof profile!=="string"){return instance.report(from,"info invalid profile")}const leader=external_window_namespaceObject.$gameMap.reqRemote(from);leader.faceName=faceName;leader.faceIndex=faceIndex;leader.name=name;leader.level=level;leader.className=className;leader.profile=profile});instance.react(external_window_namespaceObject.Scene_Base,["@","map"],"char",(scene,from,mapId,chars)=>{if(!isValidMapId(mapId)){return instance.report(from,"char invalid map")}if(external_window_namespaceObject.$gameMap.mapId()!=mapId){return}if(!isValidChars(chars)){return instance.report(from,"char invalid chars")}const leader=external_window_namespaceObject.$gameMap.reqRemote(from);if(!leader){return instance.sendto(from,"whois")}if(!leader.setChars(chars)){return instance.report(from,"char invalid data")}});instance.react(external_window_namespaceObject.Scene_Base,["@","map"],"skin",(scene,from,mapId,skins)=>{if(!isValidMapId(mapId)){return instance.report(from,"skin invalid map")}if(external_window_namespaceObject.$gameMap.mapId()!=mapId){return}if(!isValidSkins(skins)){return instance.report(from,"skin invalid skins")}const leader=external_window_namespaceObject.$gameMap.reqRemote(from);if(!leader){return instance.sendto(from,"whois")}if(!leader.setSkins(skins)){return instance.report(from,"skin invalid data")}if(scene instanceof external_window_namespaceObject.Scene_Map){scene._spriteset.reqRemote(from)}});

// FIX: Force stop packet when opening menu or leaving scene
const _Scene_Map_terminate = Scene_Map.prototype.terminate;
Scene_Map.prototype.terminate = function() {
    _Scene_Map_terminate.call(this);
    if (window.client && $gamePlayer) {
        $gamePlayer.savePosition();
        $gamePlayer.publishMoves();
    }
};

const _Scene_Map_stop = Scene_Map.prototype.stop;
Scene_Map.prototype.stop = function() {
    _Scene_Map_stop.call(this);
    if (window.client && $gamePlayer) {
        $gamePlayer.publishMoves(); 
    }
};

})();