// NATE IS THE BEST
/*!
 * /*:
 * @target MZ
 * @plugindesc Core Functionality
 * @author R.Malizia
 * @url https://rmalizia44.itch.io/
 * @help
 *
 * âš”ï¸ MMORPG Maker Plugin 0.9.5 Preview
 *
 * This plugin is the foundation for all the others; it is responsible
 * for communicating with the game server.
 *
 * ðŸ’– Special Thanks to Our Patrons!
 *
 * A huge shout-out to everyone supporting the project through Patreon!
 * Your contributions help keep this plugin alive and growing. Here are
 * the amazing supporters from each tier:
 *
 * ðŸ† Champion Tier
 *
 * - Emerson
 * - little_kaiba
 * - Sephsta
 * - fanao2
 * - hypebutter
 * - Christopher Grotheer
 *
 * ðŸŒŸ Legendary Tier
 *
 * - Alexis Naboulet
 * - Georgy
 * - Frapstery
 *
 * âœ¨ Epic Tier
 *
 * - Lupilo
 * - Richard and Adam
 * - Mr.Timbaba
 * - Kit Renard
 *
 * @param address
 * @text Address
 * @type string
 * @desc Server Address with Port
 * @default localhost:7070
 *
 * @param loginImage
 * @text Login Image
 * @type file[]
 * @desc Login Screen Images
 * @default ["img/battlebacks1/Clouds"]
 *
 * @param ssl
 * @text Use SSL
 * @type boolean
 * @desc Use SSL with Server Requests
 * @default false
 *
 * @param wsPath
 * @text WebSocket Path
 * @type string
 * @desc WebSocket endpoint path (leave blank to use address path as-is)
 * @default /api/game/start
 *
 */(()=>{"use strict";const external_window_namespaceObject=window;function prettyByte(byte){return"".concat(byte<0?"-":"","0x").concat(Math.abs(byte).toString(16).padStart(2,"0"))}var ExtData=function(){function ExtData(type,data){this.type=type;this.data=data}return ExtData}();var __extends=undefined&&undefined.__extends||function(){var extendStatics=function(d,b){extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)if(Object.prototype.hasOwnProperty.call(b,p))d[p]=b[p]};return extendStatics(d,b)};return function(d,b){if(typeof b!=="function"&&b!==null)throw new TypeError("Class extends value "+String(b)+" is not a constructor or null");extendStatics(d,b);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)}}();var DecodeError=function(_super){__extends(DecodeError,_super);function DecodeError(message){var _this=_super.call(this,message)||this;var proto=Object.create(DecodeError.prototype);Object.setPrototypeOf(_this,proto);Object.defineProperty(_this,"name",{configurable:true,enumerable:false,value:DecodeError.name});return _this}return DecodeError}(Error);var UINT32_MAX=4294967295;function setUint64(view,offset,value){var high=value/4294967296;var low=value;view.setUint32(offset,high);view.setUint32(offset+4,low)}function setInt64(view,offset,value){var high=Math.floor(value/4294967296);var low=value;view.setUint32(offset,high);view.setUint32(offset+4,low)}function getInt64(view,offset){var high=view.getInt32(offset);var low=view.getUint32(offset+4);return high*4294967296+low}function getUint64(view,offset){var high=view.getUint32(offset);var low=view.getUint32(offset+4);return high*4294967296+low}var EXT_TIMESTAMP=-1;var TIMESTAMP32_MAX_SEC=4294967296-1;var TIMESTAMP64_MAX_SEC=17179869184-1;function encodeTimeSpecToTimestamp(_a){var sec=_a.sec,nsec=_a.nsec;if(sec>=0&&nsec>=0&&sec<=TIMESTAMP64_MAX_SEC){if(nsec===0&&sec<=TIMESTAMP32_MAX_SEC){var rv=new Uint8Array(4);var view=new DataView(rv.buffer);view.setUint32(0,sec);return rv}else{var secHigh=sec/4294967296;var secLow=sec&4294967295;var rv=new Uint8Array(8);var view=new DataView(rv.buffer);view.setUint32(0,nsec<<2|secHigh&3);view.setUint32(4,secLow);return rv}}else{var rv=new Uint8Array(12);var view=new DataView(rv.buffer);view.setUint32(0,nsec);setInt64(view,4,sec);return rv}}function encodeDateToTimeSpec(date){var msec=date.getTime();var sec=Math.floor(msec/1e3);var nsec=(msec-sec*1e3)*1e6;var nsecInSec=Math.floor(nsec/1e9);return{sec:sec+nsecInSec,nsec:nsec-nsecInSec*1e9}}function encodeTimestampExtension(object){if(object instanceof Date){var timeSpec=encodeDateToTimeSpec(object);return encodeTimeSpecToTimestamp(timeSpec)}else{return null}}function decodeTimestampToTimeSpec(data){var view=new DataView(data.buffer,data.byteOffset,data.byteLength);switch(data.byteLength){case 4:{var sec=view.getUint32(0);var nsec=0;return{sec,nsec}}case 8:{var nsec30AndSecHigh2=view.getUint32(0);var secLow32=view.getUint32(4);var sec=(nsec30AndSecHigh2&3)*4294967296+secLow32;var nsec=nsec30AndSecHigh2>>>2;return{sec,nsec}}case 12:{var sec=getInt64(view,4);var nsec=view.getUint32(0);return{sec,nsec}}default:throw new DecodeError("Unrecognized data size for timestamp (expected 4, 8, or 12): ".concat(data.length))}}function decodeTimestampExtension(data){var timeSpec=decodeTimestampToTimeSpec(data);return new Date(timeSpec.sec*1e3+timeSpec.nsec/1e6)}var timestampExtension={type:EXT_TIMESTAMP,encode:encodeTimestampExtension,decode:decodeTimestampExtension};var ExtensionCodec=function(){function ExtensionCodec(){this.builtInEncoders=[];this.builtInDecoders=[];this.encoders=[];this.decoders=[];this.register(timestampExtension)}ExtensionCodec.prototype.register=function(_a){var type=_a.type,encode=_a.encode,decode=_a.decode;if(type>=0){this.encoders[type]=encode;this.decoders[type]=decode}else{var index=1+type;this.builtInEncoders[index]=encode;this.builtInDecoders[index]=decode}};ExtensionCodec.prototype.tryToEncode=function(object,context){for(var i=0;i<this.builtInEncoders.length;i++){var encodeExt=this.builtInEncoders[i];if(encodeExt!=null){var data=encodeExt(object,context);if(data!=null){var type=-1-i;return new ExtData(type,data)}}}for(var i=0;i<this.encoders.length;i++){var encodeExt=this.encoders[i];if(encodeExt!=null){var data=encodeExt(object,context);if(data!=null){var type=i;return new ExtData(type,data)}}}if(object instanceof ExtData){return object}return null};ExtensionCodec.prototype.decode=function(data,type,context){var decodeExt=type<0?this.builtInDecoders[-1-type]:this.decoders[type];if(decodeExt){return decodeExt(data,type,context)}else{return new ExtData(type,data)}};ExtensionCodec.defaultCodec=new ExtensionCodec;return ExtensionCodec}();function utf8Count(str){var strLength=str.length;var byteLength=0;var pos=0;while(pos<strLength){var value=str.charCodeAt(pos++);if((value&4294967168)===0){byteLength++;continue}else if((value&4294965248)===0){byteLength+=2}else{if(value>=55296&&value<=56319){if(pos<strLength){var extra=str.charCodeAt(pos);if((extra&64512)===56320){++pos;value=((value&1023)<<10)+(extra&1023)+65536}}}if((value&4294901760)===0){byteLength+=3}else{byteLength+=4}}}return byteLength}function utf8EncodeJs(str,output,outputOffset){var strLength=str.length;var offset=outputOffset;var pos=0;while(pos<strLength){var value=str.charCodeAt(pos++);if((value&4294967168)===0){output[offset++]=value;continue}else if((value&4294965248)===0){output[offset++]=value>>6&31|192}else{if(value>=55296&&value<=56319){if(pos<strLength){var extra=str.charCodeAt(pos);if((extra&64512)===56320){++pos;value=((value&1023)<<10)+(extra&1023)+65536}}}if((value&4294901760)===0){output[offset++]=value>>12&15|224;output[offset++]=value>>6&63|128}else{output[offset++]=value>>18&7|240;output[offset++]=value>>12&63|128;output[offset++]=value>>6&63|128}}output[offset++]=value&63|128}}var sharedTextEncoder=new TextEncoder;var TEXT_ENCODER_THRESHOLD=50;function utf8EncodeTE(str,output,outputOffset){sharedTextEncoder.encodeInto(str,output.subarray(outputOffset))}function utf8Encode(str,output,outputOffset){if(str.length>TEXT_ENCODER_THRESHOLD){utf8EncodeTE(str,output,outputOffset)}else{utf8EncodeJs(str,output,outputOffset)}}var CHUNK_SIZE=4096;function utf8DecodeJs(bytes,inputOffset,byteLength){var offset=inputOffset;var end=offset+byteLength;var units=[];var result="";while(offset<end){var byte1=bytes[offset++];if((byte1&128)===0){units.push(byte1)}else if((byte1&224)===192){var byte2=bytes[offset++]&63;units.push((byte1&31)<<6|byte2)}else if((byte1&240)===224){var byte2=bytes[offset++]&63;var byte3=bytes[offset++]&63;units.push((byte1&31)<<12|byte2<<6|byte3)}else if((byte1&248)===240){var byte2=bytes[offset++]&63;var byte3=bytes[offset++]&63;var byte4=bytes[offset++]&63;var unit=(byte1&7)<<18|byte2<<12|byte3<<6|byte4;if(unit>65535){unit-=65536;units.push(unit>>>10&1023|55296);unit=56320|unit&1023}units.push(unit)}else{units.push(byte1)}if(units.length>=CHUNK_SIZE){result+=String.fromCharCode.apply(String,units);units.length=0}}if(units.length>0){result+=String.fromCharCode.apply(String,units)}return result}var sharedTextDecoder=new TextDecoder;var TEXT_DECODER_THRESHOLD=200;function utf8DecodeTD(bytes,inputOffset,byteLength){var stringBytes=bytes.subarray(inputOffset,inputOffset+byteLength);return sharedTextDecoder.decode(stringBytes)}function utf8Decode(bytes,inputOffset,byteLength){if(byteLength>TEXT_DECODER_THRESHOLD){return utf8DecodeTD(bytes,inputOffset,byteLength)}else{return utf8DecodeJs(bytes,inputOffset,byteLength)}}function ensureUint8Array(buffer){if(buffer instanceof Uint8Array){return buffer}else if(ArrayBuffer.isView(buffer)){return new Uint8Array(buffer.buffer,buffer.byteOffset,buffer.byteLength)}else if(buffer instanceof ArrayBuffer){return new Uint8Array(buffer)}else{return Uint8Array.from(buffer)}}function createDataView(buffer){if(buffer instanceof ArrayBuffer){return new DataView(buffer)}var bufferView=ensureUint8Array(buffer);return new DataView(bufferView.buffer,bufferView.byteOffset,bufferView.byteLength)}var DEFAULT_MAX_KEY_LENGTH=16;var DEFAULT_MAX_LENGTH_PER_KEY=16;var CachedKeyDecoder=function(){function CachedKeyDecoder(maxKeyLength,maxLengthPerKey){if(maxKeyLength===void 0){maxKeyLength=DEFAULT_MAX_KEY_LENGTH}if(maxLengthPerKey===void 0){maxLengthPerKey=DEFAULT_MAX_LENGTH_PER_KEY}this.maxKeyLength=maxKeyLength;this.maxLengthPerKey=maxLengthPerKey;this.hit=0;this.miss=0;this.caches=[];for(var i=0;i<this.maxKeyLength;i++){this.caches.push([])}}CachedKeyDecoder.prototype.canBeCached=function(byteLength){return byteLength>0&&byteLength<=this.maxKeyLength};CachedKeyDecoder.prototype.find=function(bytes,inputOffset,byteLength){var records=this.caches[byteLength-1];FIND_CHUNK:for(var _i=0,records_1=records;_i<records_1.length;_i++){var record=records_1[_i];var recordBytes=record.bytes;for(var j=0;j<byteLength;j++){if(recordBytes[j]!==bytes[inputOffset+j]){continue FIND_CHUNK}}return record.str}return null};CachedKeyDecoder.prototype.store=function(bytes,value){var records=this.caches[bytes.length-1];var record={bytes,str:value};if(records.length>=this.maxLengthPerKey){records[Math.random()*records.length|0]=record}else{records.push(record)}};CachedKeyDecoder.prototype.decode=function(bytes,inputOffset,byteLength){var cachedValue=this.find(bytes,inputOffset,byteLength);if(cachedValue!=null){this.hit++;return cachedValue}this.miss++;var str=utf8DecodeJs(bytes,inputOffset,byteLength);var slicedCopyOfBytes=Uint8Array.prototype.slice.call(bytes,inputOffset,inputOffset+byteLength);this.store(slicedCopyOfBytes,str);return str};return CachedKeyDecoder}();var __awaiter=undefined&&undefined.__awaiter||function(thisArg,_arguments,P,generator){function adopt(value){return value instanceof P?value:new P(function(resolve){resolve(value)})}return new(P||(P=Promise))(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator["throw"](value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):adopt(result.value).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})};var __generator=undefined&&undefined.__generator||function(thisArg,body){var _={label:0,sent:function(){if(t[0]&1)throw t[1];return t[1]},trys:[],ops:[]},f,y,t,g;return g={next:verb(0),throw:verb(1),return:verb(2)},typeof Symbol==="function"&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return step([n,v])}}function step(op){if(f)throw new TypeError("Generator is already executing.");while(g&&(g=0,op[0]&&(_=0)),_)try{if(f=1,y&&(t=op[0]&2?y["return"]:op[0]?y["throw"]||((t=y["return"])&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;if(y=0,t)op=[op[0]&2,t.value];switch(op[0]){case 0:case 1:t=op;break;case 4:_.label++;return{value:op[1],done:false};case 5:_.label++;y=op[1];op=[0];continue;case 7:op=_.ops.pop();_.trys.pop();continue;default:if(!(t=_.trys,t=t.length>0&&t[t.length-1])&&(op[0]===6||op[0]===2)){_=0;continue}if(op[0]===3&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(op[0]===6&&_.label<t[1]){_.label=t[1];t=op;break}if(t&&_.label<t[2]){_.label=t[2];_.ops.push(op);break}if(t[2])_.ops.pop();_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e];y=0}finally{f=t=0}if(op[0]&5)throw op[1];return{value:op[0]?op[1]:void 0,done:true}}};var __asyncValues=undefined&&undefined.__asyncValues||function(o){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var m=o[Symbol.asyncIterator],i;return m?m.call(o):(o=typeof __values==="function"?__values(o):o[Symbol.iterator](),i={},verb("next"),verb("throw"),verb("return"),i[Symbol.asyncIterator]=function(){return this},i);function verb(n){i[n]=o[n]&&function(v){return new Promise(function(resolve,reject){v=o[n](v),settle(resolve,reject,v.done,v.value)})}}function settle(resolve,reject,d,v){Promise.resolve(v).then(function(v){resolve({value:v,done:d})},reject)}};var __await=undefined&&undefined.__await||function(v){return this instanceof __await?(this.v=v,this):new __await(v)};var __asyncGenerator=undefined&&undefined.__asyncGenerator||function(thisArg,_arguments,generator){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var g=generator.apply(thisArg,_arguments||[]),i,q=[];return i={},verb("next"),verb("throw"),verb("return"),i[Symbol.asyncIterator]=function(){return this},i;function verb(n){if(g[n])i[n]=function(v){return new Promise(function(a,b){q.push([n,v,a,b])>1||resume(n,v)})}}function resume(n,v){try{step(g[n](v))}catch(e){settle(q[0][3],e)}}function step(r){r.value instanceof __await?Promise.resolve(r.value.v).then(fulfill,reject):settle(q[0][2],r)}function fulfill(value){resume("next",value)}function reject(value){resume("throw",value)}function settle(f,v){if(f(v),q.shift(),q.length)resume(q[0][0],q[0][1])}};var STATE_ARRAY="array";var STATE_MAP_KEY="map_key";var STATE_MAP_VALUE="map_value";var isValidMapKeyType=function(key){return typeof key==="string"||typeof key==="number"};var HEAD_BYTE_REQUIRED=-1;var EMPTY_VIEW=new DataView(new ArrayBuffer(0));var EMPTY_BYTES=new Uint8Array(EMPTY_VIEW.buffer);try{EMPTY_VIEW.getInt8(0)}catch(e){if(!(e instanceof RangeError)){throw new Error("This module is not supported in the current JavaScript engine because DataView does not throw RangeError on out-of-bounds access")}}var DataViewIndexOutOfBoundsError=RangeError;var MORE_DATA=new DataViewIndexOutOfBoundsError("Insufficient data");var sharedCachedKeyDecoder=new CachedKeyDecoder;var Decoder_Decoder=function(){function Decoder(options){var _a,_b,_c,_d,_e,_f,_g;this.totalPos=0;this.pos=0;this.view=EMPTY_VIEW;this.bytes=EMPTY_BYTES;this.headByte=HEAD_BYTE_REQUIRED;this.stack=[];this.extensionCodec=(_a=options===null||options===void 0?void 0:options.extensionCodec)!==null&&_a!==void 0?_a:ExtensionCodec.defaultCodec;this.context=options===null||options===void 0?void 0:options.context;this.useBigInt64=(_b=options===null||options===void 0?void 0:options.useBigInt64)!==null&&_b!==void 0?_b:false;this.maxStrLength=(_c=options===null||options===void 0?void 0:options.maxStrLength)!==null&&_c!==void 0?_c:UINT32_MAX;this.maxBinLength=(_d=options===null||options===void 0?void 0:options.maxBinLength)!==null&&_d!==void 0?_d:UINT32_MAX;this.maxArrayLength=(_e=options===null||options===void 0?void 0:options.maxArrayLength)!==null&&_e!==void 0?_e:UINT32_MAX;this.maxMapLength=(_f=options===null||options===void 0?void 0:options.maxMapLength)!==null&&_f!==void 0?_f:UINT32_MAX;this.maxExtLength=(_g=options===null||options===void 0?void 0:options.maxExtLength)!==null&&_g!==void 0?_g:UINT32_MAX;this.keyDecoder=(options===null||options===void 0?void 0:options.keyDecoder)!==undefined?options.keyDecoder:sharedCachedKeyDecoder}Decoder.prototype.reinitializeState=function(){this.totalPos=0;this.headByte=HEAD_BYTE_REQUIRED;this.stack.length=0};Decoder.prototype.setBuffer=function(buffer){this.bytes=ensureUint8Array(buffer);this.view=createDataView(this.bytes);this.pos=0};Decoder.prototype.appendBuffer=function(buffer){if(this.headByte===HEAD_BYTE_REQUIRED&&!this.hasRemaining(1)){this.setBuffer(buffer)}else{var remainingData=this.bytes.subarray(this.pos);var newData=ensureUint8Array(buffer);var newBuffer=new Uint8Array(remainingData.length+newData.length);newBuffer.set(remainingData);newBuffer.set(newData,remainingData.length);this.setBuffer(newBuffer)}};Decoder.prototype.hasRemaining=function(size){return this.view.byteLength-this.pos>=size};Decoder.prototype.createExtraByteError=function(posToShow){var _a=this,view=_a.view,pos=_a.pos;return new RangeError("Extra ".concat(view.byteLength-pos," of ").concat(view.byteLength," byte(s) found at buffer[").concat(posToShow,"]"))};Decoder.prototype.decode=function(buffer){this.reinitializeState();this.setBuffer(buffer);var object=this.doDecodeSync();if(this.hasRemaining(1)){throw this.createExtraByteError(this.pos)}return object};Decoder.prototype.decodeMulti=function(buffer){return __generator(this,function(_a){switch(_a.label){case 0:this.reinitializeState();this.setBuffer(buffer);_a.label=1;case 1:if(!this.hasRemaining(1))return[3,3];return[4,this.doDecodeSync()];case 2:_a.sent();return[3,1];case 3:return[2]}})};Decoder.prototype.decodeAsync=function(stream){var _a,stream_1,stream_1_1;var _b,e_1,_c,_d;return __awaiter(this,void 0,void 0,function(){var decoded,object,buffer,e_1_1,_e,headByte,pos,totalPos;return __generator(this,function(_f){switch(_f.label){case 0:decoded=false;_f.label=1;case 1:_f.trys.push([1,6,7,12]);_a=true,stream_1=__asyncValues(stream);_f.label=2;case 2:return[4,stream_1.next()];case 3:if(!(stream_1_1=_f.sent(),_b=stream_1_1.done,!_b))return[3,5];_d=stream_1_1.value;_a=false;try{buffer=_d;if(decoded){throw this.createExtraByteError(this.totalPos)}this.appendBuffer(buffer);try{object=this.doDecodeSync();decoded=true}catch(e){if(!(e instanceof DataViewIndexOutOfBoundsError)){throw e}}this.totalPos+=this.pos}finally{_a=true}_f.label=4;case 4:return[3,2];case 5:return[3,12];case 6:e_1_1=_f.sent();e_1={error:e_1_1};return[3,12];case 7:_f.trys.push([7,,10,11]);if(!(!_a&&!_b&&(_c=stream_1.return)))return[3,9];return[4,_c.call(stream_1)];case 8:_f.sent();_f.label=9;case 9:return[3,11];case 10:if(e_1)throw e_1.error;return[7];case 11:return[7];case 12:if(decoded){if(this.hasRemaining(1)){throw this.createExtraByteError(this.totalPos)}return[2,object]}_e=this,headByte=_e.headByte,pos=_e.pos,totalPos=_e.totalPos;throw new RangeError("Insufficient data in parsing ".concat(prettyByte(headByte)," at ").concat(totalPos," (").concat(pos," in the current buffer)"))}})})};Decoder.prototype.decodeArrayStream=function(stream){return this.decodeMultiAsync(stream,true)};Decoder.prototype.decodeStream=function(stream){return this.decodeMultiAsync(stream,false)};Decoder.prototype.decodeMultiAsync=function(stream,isArray){return __asyncGenerator(this,arguments,function decodeMultiAsync_1(){var isArrayHeaderRequired,arrayItemsLeft,_a,stream_2,stream_2_1,buffer,e_2,e_3_1;var _b,e_3,_c,_d;return __generator(this,function(_e){switch(_e.label){case 0:isArrayHeaderRequired=isArray;arrayItemsLeft=-1;_e.label=1;case 1:_e.trys.push([1,15,16,21]);_a=true,stream_2=__asyncValues(stream);_e.label=2;case 2:return[4,__await(stream_2.next())];case 3:if(!(stream_2_1=_e.sent(),_b=stream_2_1.done,!_b))return[3,14];_d=stream_2_1.value;_a=false;_e.label=4;case 4:_e.trys.push([4,,12,13]);buffer=_d;if(isArray&&arrayItemsLeft===0){throw this.createExtraByteError(this.totalPos)}this.appendBuffer(buffer);if(isArrayHeaderRequired){arrayItemsLeft=this.readArraySize();isArrayHeaderRequired=false;this.complete()}_e.label=5;case 5:_e.trys.push([5,10,,11]);_e.label=6;case 6:if(false){}return[4,__await(this.doDecodeSync())];case 7:return[4,_e.sent()];case 8:_e.sent();if(--arrayItemsLeft===0){return[3,9]}return[3,6];case 9:return[3,11];case 10:e_2=_e.sent();if(!(e_2 instanceof DataViewIndexOutOfBoundsError)){throw e_2}return[3,11];case 11:this.totalPos+=this.pos;return[3,13];case 12:_a=true;return[7];case 13:return[3,2];case 14:return[3,21];case 15:e_3_1=_e.sent();e_3={error:e_3_1};return[3,21];case 16:_e.trys.push([16,,19,20]);if(!(!_a&&!_b&&(_c=stream_2.return)))return[3,18];return[4,__await(_c.call(stream_2))];case 17:_e.sent();_e.label=18;case 18:return[3,20];case 19:if(e_3)throw e_3.error;return[7];case 20:return[7];case 21:return[2]}})})};Decoder.prototype.doDecodeSync=function(){DECODE:while(true){var headByte=this.readHeadByte();var object=void 0;if(headByte>=224){object=headByte-256}else if(headByte<192){if(headByte<128){object=headByte}else if(headByte<144){var size=headByte-128;if(size!==0){this.pushMapState(size);this.complete();continue DECODE}else{object={}}}else if(headByte<160){var size=headByte-144;if(size!==0){this.pushArrayState(size);this.complete();continue DECODE}else{object=[]}}else{var byteLength=headByte-160;object=this.decodeUtf8String(byteLength,0)}}else if(headByte===192){object=null}else if(headByte===194){object=false}else if(headByte===195){object=true}else if(headByte===202){object=this.readF32()}else if(headByte===203){object=this.readF64()}else if(headByte===204){object=this.readU8()}else if(headByte===205){object=this.readU16()}else if(headByte===206){object=this.readU32()}else if(headByte===207){if(this.useBigInt64){object=this.readU64AsBigInt()}else{object=this.readU64()}}else if(headByte===208){object=this.readI8()}else if(headByte===209){object=this.readI16()}else if(headByte===210){object=this.readI32()}else if(headByte===211){if(this.useBigInt64){object=this.readI64AsBigInt()}else{object=this.readI64()}}else if(headByte===217){var byteLength=this.lookU8();object=this.decodeUtf8String(byteLength,1)}else if(headByte===218){var byteLength=this.lookU16();object=this.decodeUtf8String(byteLength,2)}else if(headByte===219){var byteLength=this.lookU32();object=this.decodeUtf8String(byteLength,4)}else if(headByte===220){var size=this.readU16();if(size!==0){this.pushArrayState(size);this.complete();continue DECODE}else{object=[]}}else if(headByte===221){var size=this.readU32();if(size!==0){this.pushArrayState(size);this.complete();continue DECODE}else{object=[]}}else if(headByte===222){var size=this.readU16();if(size!==0){this.pushMapState(size);this.complete();continue DECODE}else{object={}}}else if(headByte===223){var size=this.readU32();if(size!==0){this.pushMapState(size);this.complete();continue DECODE}else{object={}}}else if(headByte===196){var size=this.lookU8();object=this.decodeBinary(size,1)}else if(headByte===197){var size=this.lookU16();object=this.decodeBinary(size,2)}else if(headByte===198){var size=this.lookU32();object=this.decodeBinary(size,4)}else if(headByte===212){object=this.decodeExtension(1,0)}else if(headByte===213){object=this.decodeExtension(2,0)}else if(headByte===214){object=this.decodeExtension(4,0)}else if(headByte===215){object=this.decodeExtension(8,0)}else if(headByte===216){object=this.decodeExtension(16,0)}else if(headByte===199){var size=this.lookU8();object=this.decodeExtension(size,1)}else if(headByte===200){var size=this.lookU16();object=this.decodeExtension(size,2)}else if(headByte===201){var size=this.lookU32();object=this.decodeExtension(size,4)}else{throw new DecodeError("Unrecognized type byte: ".concat(prettyByte(headByte)))}this.complete();var stack=this.stack;while(stack.length>0){var state=stack[stack.length-1];if(state.type===STATE_ARRAY){state.array[state.position]=object;state.position++;if(state.position===state.size){stack.pop();object=state.array}else{continue DECODE}}else if(state.type===STATE_MAP_KEY){if(!isValidMapKeyType(object)){throw new DecodeError("The type of key must be string or number but "+typeof object)}if(object==="__proto__"){throw new DecodeError("The key __proto__ is not allowed")}state.key=object;state.type=STATE_MAP_VALUE;continue DECODE}else{state.map[state.key]=object;state.readCount++;if(state.readCount===state.size){stack.pop();object=state.map}else{state.key=null;state.type=STATE_MAP_KEY;continue DECODE}}}return object}};Decoder.prototype.readHeadByte=function(){if(this.headByte===HEAD_BYTE_REQUIRED){this.headByte=this.readU8()}return this.headByte};Decoder.prototype.complete=function(){this.headByte=HEAD_BYTE_REQUIRED};Decoder.prototype.readArraySize=function(){var headByte=this.readHeadByte();switch(headByte){case 220:return this.readU16();case 221:return this.readU32();default:{if(headByte<160){return headByte-144}else{throw new DecodeError("Unrecognized array type byte: ".concat(prettyByte(headByte)))}}}};Decoder.prototype.pushMapState=function(size){if(size>this.maxMapLength){throw new DecodeError("Max length exceeded: map length (".concat(size,") > maxMapLengthLength (").concat(this.maxMapLength,")"))}this.stack.push({type:STATE_MAP_KEY,size,key:null,readCount:0,map:{}})};Decoder.prototype.pushArrayState=function(size){if(size>this.maxArrayLength){throw new DecodeError("Max length exceeded: array length (".concat(size,") > maxArrayLength (").concat(this.maxArrayLength,")"))}this.stack.push({type:STATE_ARRAY,size,array:new Array(size),position:0})};Decoder.prototype.decodeUtf8String=function(byteLength,headerOffset){var _a;if(byteLength>this.maxStrLength){throw new DecodeError("Max length exceeded: UTF-8 byte length (".concat(byteLength,") > maxStrLength (").concat(this.maxStrLength,")"))}if(this.bytes.byteLength<this.pos+headerOffset+byteLength){throw MORE_DATA}var offset=this.pos+headerOffset;var object;if(this.stateIsMapKey()&&((_a=this.keyDecoder)===null||_a===void 0?void 0:_a.canBeCached(byteLength))){object=this.keyDecoder.decode(this.bytes,offset,byteLength)}else{object=utf8Decode(this.bytes,offset,byteLength)}this.pos+=headerOffset+byteLength;return object};Decoder.prototype.stateIsMapKey=function(){if(this.stack.length>0){var state=this.stack[this.stack.length-1];return state.type===STATE_MAP_KEY}return false};Decoder.prototype.decodeBinary=function(byteLength,headOffset){if(byteLength>this.maxBinLength){throw new DecodeError("Max length exceeded: bin length (".concat(byteLength,") > maxBinLength (").concat(this.maxBinLength,")"))}if(!this.hasRemaining(byteLength+headOffset)){throw MORE_DATA}var offset=this.pos+headOffset;var object=this.bytes.subarray(offset,offset+byteLength);this.pos+=headOffset+byteLength;return object};Decoder.prototype.decodeExtension=function(size,headOffset){if(size>this.maxExtLength){throw new DecodeError("Max length exceeded: ext length (".concat(size,") > maxExtLength (").concat(this.maxExtLength,")"))}var extType=this.view.getInt8(this.pos+headOffset);var data=this.decodeBinary(size,headOffset+1);return this.extensionCodec.decode(data,extType,this.context)};Decoder.prototype.lookU8=function(){return this.view.getUint8(this.pos)};Decoder.prototype.lookU16=function(){return this.view.getUint16(this.pos)};Decoder.prototype.lookU32=function(){return this.view.getUint32(this.pos)};Decoder.prototype.readU8=function(){var value=this.view.getUint8(this.pos);this.pos++;return value};Decoder.prototype.readI8=function(){var value=this.view.getInt8(this.pos);this.pos++;return value};Decoder.prototype.readU16=function(){var value=this.view.getUint16(this.pos);this.pos+=2;return value};Decoder.prototype.readI16=function(){var value=this.view.getInt16(this.pos);this.pos+=2;return value};Decoder.prototype.readU32=function(){var value=this.view.getUint32(this.pos);this.pos+=4;return value};Decoder.prototype.readI32=function(){var value=this.view.getInt32(this.pos);this.pos+=4;return value};Decoder.prototype.readU64=function(){var value=getUint64(this.view,this.pos);this.pos+=8;return value};Decoder.prototype.readI64=function(){var value=getInt64(this.view,this.pos);this.pos+=8;return value};Decoder.prototype.readU64AsBigInt=function(){var value=this.view.getBigUint64(this.pos);this.pos+=8;return value};Decoder.prototype.readI64AsBigInt=function(){var value=this.view.getBigInt64(this.pos);this.pos+=8;return value};Decoder.prototype.readF32=function(){var value=this.view.getFloat32(this.pos);this.pos+=4;return value};Decoder.prototype.readF64=function(){var value=this.view.getFloat64(this.pos);this.pos+=8;return value};return Decoder}();var defaultDecodeOptions=null&&undefined;function decode(buffer,options){var decoder=new Decoder_Decoder(options);return decoder.decode(buffer)}function decodeMulti(buffer,options){var decoder=new Decoder(options);return decoder.decodeMulti(buffer)}var DEFAULT_MAX_DEPTH=100;var DEFAULT_INITIAL_BUFFER_SIZE=2048;var Encoder=function(){function Encoder(options){var _a,_b,_c,_d,_e,_f,_g,_h;this.extensionCodec=(_a=options===null||options===void 0?void 0:options.extensionCodec)!==null&&_a!==void 0?_a:ExtensionCodec.defaultCodec;this.context=options===null||options===void 0?void 0:options.context;this.useBigInt64=(_b=options===null||options===void 0?void 0:options.useBigInt64)!==null&&_b!==void 0?_b:false;this.maxDepth=(_c=options===null||options===void 0?void 0:options.maxDepth)!==null&&_c!==void 0?_c:DEFAULT_MAX_DEPTH;this.initialBufferSize=(_d=options===null||options===void 0?void 0:options.initialBufferSize)!==null&&_d!==void 0?_d:DEFAULT_INITIAL_BUFFER_SIZE;this.sortKeys=(_e=options===null||options===void 0?void 0:options.sortKeys)!==null&&_e!==void 0?_e:false;this.forceFloat32=(_f=options===null||options===void 0?void 0:options.forceFloat32)!==null&&_f!==void 0?_f:false;this.ignoreUndefined=(_g=options===null||options===void 0?void 0:options.ignoreUndefined)!==null&&_g!==void 0?_g:false;this.forceIntegerToFloat=(_h=options===null||options===void 0?void 0:options.forceIntegerToFloat)!==null&&_h!==void 0?_h:false;this.pos=0;this.view=new DataView(new ArrayBuffer(this.initialBufferSize));this.bytes=new Uint8Array(this.view.buffer)}Encoder.prototype.reinitializeState=function(){this.pos=0};Encoder.prototype.encodeSharedRef=function(object){this.reinitializeState();this.doEncode(object,1);return this.bytes.subarray(0,this.pos)};Encoder.prototype.encode=function(object){this.reinitializeState();this.doEncode(object,1);return this.bytes.slice(0,this.pos)};Encoder.prototype.doEncode=function(object,depth){if(depth>this.maxDepth){throw new Error("Too deep objects in depth ".concat(depth))}if(object==null){this.encodeNil()}else if(typeof object==="boolean"){this.encodeBoolean(object)}else if(typeof object==="number"){if(!this.forceIntegerToFloat){this.encodeNumber(object)}else{this.encodeNumberAsFloat(object)}}else if(typeof object==="string"){this.encodeString(object)}else if(this.useBigInt64&&typeof object==="bigint"){this.encodeBigInt64(object)}else{this.encodeObject(object,depth)}};Encoder.prototype.ensureBufferSizeToWrite=function(sizeToWrite){var requiredSize=this.pos+sizeToWrite;if(this.view.byteLength<requiredSize){this.resizeBuffer(requiredSize*2)}};Encoder.prototype.resizeBuffer=function(newSize){var newBuffer=new ArrayBuffer(newSize);var newBytes=new Uint8Array(newBuffer);var newView=new DataView(newBuffer);newBytes.set(this.bytes);this.view=newView;this.bytes=newBytes};Encoder.prototype.encodeNil=function(){this.writeU8(192)};Encoder.prototype.encodeBoolean=function(object){if(object===false){this.writeU8(194)}else{this.writeU8(195)}};Encoder.prototype.encodeNumber=function(object){if(!this.forceIntegerToFloat&&Number.isSafeInteger(object)){if(object>=0){if(object<128){this.writeU8(object)}else if(object<256){this.writeU8(204);this.writeU8(object)}else if(object<65536){this.writeU8(205);this.writeU16(object)}else if(object<4294967296){this.writeU8(206);this.writeU32(object)}else if(!this.useBigInt64){this.writeU8(207);this.writeU64(object)}else{this.encodeNumberAsFloat(object)}}else{if(object>=-32){this.writeU8(224|object+32)}else if(object>=-128){this.writeU8(208);this.writeI8(object)}else if(object>=-32768){this.writeU8(209);this.writeI16(object)}else if(object>=-2147483648){this.writeU8(210);this.writeI32(object)}else if(!this.useBigInt64){this.writeU8(211);this.writeI64(object)}else{this.encodeNumberAsFloat(object)}}}else{this.encodeNumberAsFloat(object)}};Encoder.prototype.encodeNumberAsFloat=function(object){if(this.forceFloat32){this.writeU8(202);this.writeF32(object)}else{this.writeU8(203);this.writeF64(object)}};Encoder.prototype.encodeBigInt64=function(object){if(object>=BigInt(0)){this.writeU8(207);this.writeBigUint64(object)}else{this.writeU8(211);this.writeBigInt64(object)}};Encoder.prototype.writeStringHeader=function(byteLength){if(byteLength<32){this.writeU8(160+byteLength)}else if(byteLength<256){this.writeU8(217);this.writeU8(byteLength)}else if(byteLength<65536){this.writeU8(218);this.writeU16(byteLength)}else if(byteLength<4294967296){this.writeU8(219);this.writeU32(byteLength)}else{throw new Error("Too long string: ".concat(byteLength," bytes in UTF-8"))}};Encoder.prototype.encodeString=function(object){var maxHeaderSize=1+4;var byteLength=utf8Count(object);this.ensureBufferSizeToWrite(maxHeaderSize+byteLength);this.writeStringHeader(byteLength);utf8Encode(object,this.bytes,this.pos);this.pos+=byteLength};Encoder.prototype.encodeObject=function(object,depth){var ext=this.extensionCodec.tryToEncode(object,this.context);if(ext!=null){this.encodeExtension(ext)}else if(Array.isArray(object)){this.encodeArray(object,depth)}else if(ArrayBuffer.isView(object)){this.encodeBinary(object)}else if(typeof object==="object"){this.encodeMap(object,depth)}else{throw new Error("Unrecognized object: ".concat(Object.prototype.toString.apply(object)))}};Encoder.prototype.encodeBinary=function(object){var size=object.byteLength;if(size<256){this.writeU8(196);this.writeU8(size)}else if(size<65536){this.writeU8(197);this.writeU16(size)}else if(size<4294967296){this.writeU8(198);this.writeU32(size)}else{throw new Error("Too large binary: ".concat(size))}var bytes=ensureUint8Array(object);this.writeU8a(bytes)};Encoder.prototype.encodeArray=function(object,depth){var size=object.length;if(size<16){this.writeU8(144+size)}else if(size<65536){this.writeU8(220);this.writeU16(size)}else if(size<4294967296){this.writeU8(221);this.writeU32(size)}else{throw new Error("Too large array: ".concat(size))}for(var _i=0,object_1=object;_i<object_1.length;_i++){var item=object_1[_i];this.doEncode(item,depth+1)}};Encoder.prototype.countWithoutUndefined=function(object,keys){var count=0;for(var _i=0,keys_1=keys;_i<keys_1.length;_i++){var key=keys_1[_i];if(object[key]!==undefined){count++}}return count};Encoder.prototype.encodeMap=function(object,depth){var keys=Object.keys(object);if(this.sortKeys){keys.sort()}var size=this.ignoreUndefined?this.countWithoutUndefined(object,keys):keys.length;if(size<16){this.writeU8(128+size)}else if(size<65536){this.writeU8(222);this.writeU16(size)}else if(size<4294967296){this.writeU8(223);this.writeU32(size)}else{throw new Error("Too large map object: ".concat(size))}for(var _i=0,keys_2=keys;_i<keys_2.length;_i++){var key=keys_2[_i];var value=object[key];if(!(this.ignoreUndefined&&value===undefined)){this.encodeString(key);this.doEncode(value,depth+1)}}};Encoder.prototype.encodeExtension=function(ext){var size=ext.data.length;if(size===1){this.writeU8(212)}else if(size===2){this.writeU8(213)}else if(size===4){this.writeU8(214)}else if(size===8){this.writeU8(215)}else if(size===16){this.writeU8(216)}else if(size<256){this.writeU8(199);this.writeU8(size)}else if(size<65536){this.writeU8(200);this.writeU16(size)}else if(size<4294967296){this.writeU8(201);this.writeU32(size)}else{throw new Error("Too large extension object: ".concat(size))}this.writeI8(ext.type);this.writeU8a(ext.data)};Encoder.prototype.writeU8=function(value){this.ensureBufferSizeToWrite(1);this.view.setUint8(this.pos,value);this.pos++};Encoder.prototype.writeU8a=function(values){var size=values.length;this.ensureBufferSizeToWrite(size);this.bytes.set(values,this.pos);this.pos+=size};Encoder.prototype.writeI8=function(value){this.ensureBufferSizeToWrite(1);this.view.setInt8(this.pos,value);this.pos++};Encoder.prototype.writeU16=function(value){this.ensureBufferSizeToWrite(2);this.view.setUint16(this.pos,value);this.pos+=2};Encoder.prototype.writeI16=function(value){this.ensureBufferSizeToWrite(2);this.view.setInt16(this.pos,value);this.pos+=2};Encoder.prototype.writeU32=function(value){this.ensureBufferSizeToWrite(4);this.view.setUint32(this.pos,value);this.pos+=4};Encoder.prototype.writeI32=function(value){this.ensureBufferSizeToWrite(4);this.view.setInt32(this.pos,value);this.pos+=4};Encoder.prototype.writeF32=function(value){this.ensureBufferSizeToWrite(4);this.view.setFloat32(this.pos,value);this.pos+=4};Encoder.prototype.writeF64=function(value){this.ensureBufferSizeToWrite(8);this.view.setFloat64(this.pos,value);this.pos+=8};Encoder.prototype.writeU64=function(value){this.ensureBufferSizeToWrite(8);setUint64(this.view,this.pos,value);this.pos+=8};Encoder.prototype.writeI64=function(value){this.ensureBufferSizeToWrite(8);setInt64(this.view,this.pos,value);this.pos+=8};Encoder.prototype.writeBigUint64=function(value){this.ensureBufferSizeToWrite(8);this.view.setBigUint64(this.pos,value);this.pos+=8};Encoder.prototype.writeBigInt64=function(value){this.ensureBufferSizeToWrite(8);this.view.setBigInt64(this.pos,value);this.pos+=8};return Encoder}();var defaultEncodeOptions=null&&undefined;function encode(value,options){var encoder=new Encoder(options);return encoder.encodeSharedRef(value)}class Reader{static _decoder=new TextDecoder;_data=new Uint8Array;reset(data){this._data=new Uint8Array(data)}bytes(){return new Uint8Array(this._data)}size(){return this._data.length}empty(){return this.size()<1}getByte(){if(this.size()<1){throw new Error("not enough data to read a byte")}const value=this._data[0];this._data=this._data.slice(1);return value}getBytes(len){if(this.size()<len){throw new Error("not enough data to read bytes")}const value=this._data.slice(0,len);this._data=this._data.slice(len);return value}getString(){const len=this.getByte();const bytes=this.getBytes(len);return Reader._decoder.decode(bytes)}getValue(){const len=this.getByte();const bytes=this.getBytes(len);return len>0?decode(bytes):undefined}}class Writer{static _encoder=new TextEncoder;_buf=new Uint8Array(1024);_pos=0;reset(){this._pos=0}bytes(){return this._buf.slice(0,this._pos)}left(){return this._buf.length-this._pos}size(){return this._pos}putByte(value){if(this.left()<1){throw new Error("not enough space to write a byte")}this._buf[this._pos++]=value}putBytes(value){const len=value.length;if(this.left()<len){throw new Error("not enough space to write bytes")}this._buf.set(value,this._pos);this._pos+=len}putString(value){const bytes=Writer._encoder.encode(value);this.putByte(bytes.length);this.putBytes(bytes)}putValue(value){const bytes=encode(value);this.putByte(bytes.length);this.putBytes(bytes)}}class ClientBase{_callbacks=new Map;_ws;connect(addr,token,wsPath){const trimmed=addr.endsWith('/')?addr.slice(0,-1):addr;const hasPath=/^wss?:\/\/[^/]+\/.+/.test(trimmed);const rawPath=wsPath===undefined?"":wsPath.trim();const path=rawPath===""?(hasPath?"":"/api/game/start"):rawPath;const suffix=path?path.startsWith('/')?path:`/${path}`:"";const urlBase=`${trimmed}${suffix}`;const joiner=urlBase.includes('?')?'&':'?';const url=`${urlBase}${joiner}token=${token}`;const ws=new WebSocket(url);ws.binaryType="arraybuffer";ws.onopen=this.cbOpen.bind(this,ws);ws.onclose=this.cbClose.bind(this);ws.onerror=this.cbError.bind(this);ws.onmessage=this.cbMessage.bind(this)}isReady(){return!!this._ws}uniqueKey(){let key;do{key=Math.random()}while(this._callbacks.has(key));return key}resolveResult(value){if(value instanceof Promise){value.catch(console.error)}}cbOpen(ws){this._ws=ws;this.resolveResult(this.onOpen())}cbClose(evt){this._ws=undefined;this.resolveResult(this.onClose(evt.reason))}cbError(evt){console.error(evt);this.resolveResult(this.onError())}cbMessage(evt){try{const reader=new Reader;reader.reset(new Uint8Array(evt.data));switch(reader.getByte()){case 0:return this.cbPong(reader);case 1:return this.cbResp(reader);case 2:return this.cbRecv(reader);default:throw new Error}}catch(e){console.error(e)}}cbPong(reader){const time=reader.getValue();const delta=Date.now()-time;this.resolveResult(this.onPong(delta))}cbResp(reader){const query=reader.getValue();const cb=this._callbacks.get(query);this._callbacks.delete(query);if(!cb){return}try{const values={};while(!reader.empty()){const field=reader.getString();const value=reader.getValue();values[field]=value}this.resolveResult(cb(values))}catch(e){console.error(e);this.resolveResult(cb({}))}}cbRecv(reader){const group=reader.getString();const from=reader.getString();const code=reader.getString();try{const args=reader.size()>0?decode(reader.bytes()):[];if(!Array.isArray(args)){console.error(`invalid recv packet from ${from}`);return}this.resolveResult(this.onRecv(group,from,code,args))}catch(e){console.error(e)}}send(data){if(!this._ws){throw new Error(`network not started`)}this._ws.send(data)}ping(){const writer=new Writer;writer.putByte(0);writer.putValue(Date.now());this.send(writer.bytes())}load(global,name,cb){const query=this.uniqueKey();const writer=new Writer;writer.putByte(1);writer.putByte(global?1:0);writer.putString(name);writer.putValue(query);this._callbacks.set(query,cb);this.send(writer.bytes())}loadAsync(global,name){return new Promise(resolve=>{this.load(global,name,resolve)})}save(global,name,values){const writer=new Writer;writer.putByte(2);writer.putByte(global?1:0);writer.putString(name);for(const field in values){const value=values[field];writer.putString(field);writer.putValue(value)}this.send(writer.bytes())}subscribe(group,name,...args){const writer=new Writer;writer.putByte(3);writer.putString(group);writer.putString(name||"");writer.putBytes(encode(args));this.send(writer.bytes())}broadcast(loopback,code,...args){const writer=new Writer;writer.putByte(4);writer.putByte(loopback?1:0);writer.putString(code);writer.putBytes(encode(args));this.send(writer.bytes())}publish(loopback,group,code,...args){const writer=new Writer;writer.putByte(5);writer.putByte(loopback?1:0);writer.putString(group);writer.putString(code);writer.putBytes(encode(args));this.send(writer.bytes())}sendto(user,code,...args){const writer=new Writer;writer.putByte(6);writer.putString(user);writer.putString(code);writer.putBytes(encode(args));this.send(writer.bytes())}report(reported,reason){const writer=new Writer;writer.putByte(9);writer.putString(reported);writer.putString(reason);this.send(writer.bytes())}online(cb){const query=this.uniqueKey();const writer=new Writer;writer.putByte(100);writer.putValue(query);this._callbacks.set(query,cb);this.send(writer.bytes())}onlineAsync(){return new Promise(resolve=>{this.online(resolve)})}banned(cb){const query=this.uniqueKey();const writer=new Writer;writer.putByte(101);writer.putValue(query);this._callbacks.set(query,cb);this.send(writer.bytes())}bannedAsync(){return new Promise(resolve=>{this.banned(resolve)})}banning(user,state,cb){const query=this.uniqueKey();const writer=new Writer;writer.putByte(102);writer.putString(user);writer.putByte(state?1:0);writer.putValue(query);this._callbacks.set(query,cb);this.send(writer.bytes())}banningAsync(user,state){return new Promise(resolve=>{this.banning(user,state,resolve)})}inspect(user,name,cb){const query=this.uniqueKey();const writer=new Writer;writer.putByte(103);writer.putString(user);writer.putString(name);writer.putValue(query);this._callbacks.set(query,cb);this.send(writer.bytes())}inspectAsync(user,name){return new Promise(resolve=>{this.inspect(user,name,resolve)})}overwrite(user,name,values,cb){const query=this.uniqueKey();const writer=new Writer;writer.putByte(104);writer.putString(user);writer.putString(name);writer.putValue(query);for(const field in values){const value=values[field];writer.putString(field);writer.putValue(value)}this._callbacks.set(query,cb);this.send(writer.bytes())}overwriteAsync(user,name,values){return new Promise(resolve=>{this.overwrite(user,name,values,resolve)})}}class InvalidTokenError extends Error{}InvalidTokenError.prototype.name="InvalidTokenError";function b64DecodeUnicode(str){return decodeURIComponent(atob(str).replace(/(.)/g,(m,p)=>{let code=p.charCodeAt(0).toString(16).toUpperCase();if(code.length<2){code="0"+code}return"%"+code}))}function base64UrlDecode(str){let output=str.replace(/-/g,"+").replace(/_/g,"/");switch(output.length%4){case 0:break;case 2:output+="==";break;case 3:output+="=";break;default:throw new Error("base64 string is not of the correct length")}try{return b64DecodeUnicode(output)}catch(err){return atob(output)}}function jwtDecode(token,options){if(typeof token!=="string"){throw new InvalidTokenError("Invalid token specified: must be a string")}options||(options={});const pos=options.header===true?0:1;const part=token.split(".")[pos];if(typeof part!=="string"){throw new InvalidTokenError(`Invalid token specified: missing part #${pos+1}`)}let decoded;try{decoded=base64UrlDecode(part)}catch(e){throw new InvalidTokenError(`Invalid token specified: invalid base64 for part #${pos+1} (${e.message})`)}try{return JSON.parse(decoded)}catch(e){throw new InvalidTokenError(`Invalid token specified: invalid json for part #${pos+1} (${e.message})`)}}function getToken(){return localStorage.getItem("WS_TOKEN")}function setToken(token){if(token){localStorage.setItem("WS_TOKEN",token)}else{localStorage.removeItem("WS_TOKEN")}}function decodeToken(token){return jwtDecode(token)}class Callbacks{_values=new Array;_funcs=new Map;tryFuncs(key){return this._funcs.get(key)}reqFuncs(key){let list=this._funcs.get(key);if(!list){list=[];this._funcs.set(key,list)}return list}addValue(key,value){this._values.push([key,value])}addFunc(key,func){this.reqFuncs(key).push(func)}next(){return this._values.shift()}}function log(...args){if(true){return}}const src_log=log;const PING_TIMEOUT=2e3;const KICK_CODES={FB3D175F:"Another user logged in this account","41B6348E":"Invalid Packet",FDA3D976:"Banned by Admin"};class ClientImpl extends ClientBase{_toload=new Array;_msgs=new Callbacks;_token="";_user="";_admin=false;_ping;_error=false;constructor(){super();const token=getToken();if(!token){src_log("token invalid, redirecting");this.retry(true);return}this._token=token;const payload=decodeToken(this._token);src_log("ADMIN:",payload.adm);this._admin=!!payload.adm;const user=payload.sub;if(!user){src_log("token user invalid, redirecting");this.retry(true);return}this._user=user;if(!payload.exp||payload.exp<Date.now()/1e3){src_log("token expired, redirecting");this.retry(true);return}const parameters=external_window_namespaceObject.PluginManager.parameters("MMORPG_Client");if(!parameters){throw new Error("invalid server parameters")}const{ssl,address,wsPath}=parameters;const base=/^wss?:\/\//.test(address)?address:`${ssl=="true"?"wss":"ws"}://${address}`;this.connect(base,this._token,wsPath)}user(){return this._user}admin(){return this._admin}getPing(){return this._ping?Math.round(this._ping):null}logout(){setToken(undefined);this.retry(true)}retry(toLogin){if(toLogin){location.href="login.html"}else{location.reload()}}onOpen(){src_log("OPEN");this.setPingTimeout()}onClose(reason){src_log("CLOSE",reason);const text=reason?KICK_CODES[reason]:null;if(text){alert(text)}this.retry(this._error||!!reason)}onError(){src_log("ERROR");this._error=true;this.retry(true)}save(global,name,values){src_log("<","save",global,name,values);super.save(global,name,values)}load(global,name,cb){src_log("<","load",global,name);super.load(global,name,v=>{src_log(">","load",global,name,v);cb(v)})}subscribe(group,name,...args){src_log("<","subscribe",group,name,...args);super.subscribe(group,name,...args)}broadcast(loopback,code,...args){this.unsafeBroadcast(loopback,code,...args)}publish(loopback,group,code,...args){this.unsafePublish(loopback,group,code,...args)}sendto(user,code,...args){this.unsafeSendto(user,code,...args)}report(reported,reason){src_log("<","report",reported,reason);super.report(reported,reason)}onPingTimeout(){if(this.isReady()){this.ping()}else{this.setPingTimeout()}}setPingTimeout(){setTimeout(()=>this.onPingTimeout(),PING_TIMEOUT)}onPong(ping){try{if(this._ping){this._ping=(this._ping+ping)/2}else{this._ping=ping}const title=external_window_namespaceObject.$dataSystem?.gameTitle;if(title){document.title=`${title} (${this.getPing()} ms)`}}finally{this.setPingTimeout()}}makeKey(group,code){return JSON.stringify([group,code])}onRecv(group,from,code,args){src_log(">","recv",group,from,code,...args);this._msgs.addValue(this.makeKey(group,code),[from,args])}start(global,name,func){this._toload.push([global,name,func])}react(sceneClass,group,code,func){this.unsafeReact(sceneClass,group,code,func)}safeBroadcast(type,loopback,code,data){const result=type.safeParse(data);if(result.success){this.unsafeBroadcast(loopback,code,data)}else if(false){}else{console.error(`trying to broadcast invalid message with code [${code}]:`,result.error);console.error(result.error)}}safePublish(type,loopback,group,code,data){const result=type.safeParse(data);if(result.success){this.unsafePublish(loopback,group,code,data)}else if(false){}else{console.error(`trying to publish invalid message in group [${group}] with code [${code}]:`,result.error);console.error(result.error)}}safeSendto(type,user,code,data){const result=type.safeParse(data);if(result.success){this.unsafeSendto(user,code,data)}else if(false){}else{console.error(`trying to send invalid message to [${user}] with code [${code}]:`,result.error);console.error(result.error)}}safeReact(sceneClass,type,group,code,func){this.unsafeReact(sceneClass,group,code,(scene,from,data)=>{const result=type.safeParse(data);if(result.success){func(scene,from,result.data)}else if(false){}else{console.error(`received invalid message from [${from}] in group [${group}] with code [${code}]:`,result.error);this.report(from,`sent invalid type: ${group}, ${code}`)}})}toload(){return Array.from(this._toload)}unsafeBroadcast(loopback,code,...args){src_log("<","broadcast",loopback,code,...args);super.broadcast(loopback,code,...args)}unsafePublish(loopback,group,code,...args){src_log("<","publish",loopback,group,code,...args);super.publish(loopback,group,code,...args)}unsafeSendto(user,code,...args){src_log("<","sendto",user,code,...args);super.sendto(user,code,...args)}unsafeReact(sceneClass,group,code,func){const groups=Array.isArray(group)?group:[group];for(const g of groups){this._msgs.addFunc(this.makeKey(g,code),tuple=>{const[from,args]=tuple;const scene=external_window_namespaceObject.SceneManager._scene;if(!(scene instanceof sceneClass)){return}src_log("$",sceneClass.name,g,from,code,...args);const result=func(scene,from,...args);if(result instanceof Promise){result.catch(console.error)}})}}updateCallbacks(cbs){let pair;while(pair=cbs.next()){const[key,value]=pair;const list=cbs.tryFuncs(key);if(!list){src_log("unhandled:",key,value);continue}for(const func of list){try{func(value)}catch(e){console.error(e)}}}}update(){this.updateCallbacks(this._msgs)}}const Scene_Base_isReady=external_window_namespaceObject.Scene_Base.prototype.isReady;external_window_namespaceObject.Scene_Base.prototype.isReady=function(){return Scene_Base_isReady.call(this)&&window.client.isReady()};const Scene_Base_update=external_window_namespaceObject.Scene_Base.prototype.update;external_window_namespaceObject.Scene_Base.prototype.update=function(){window.client.update();Scene_Base_update.call(this)};external_window_namespaceObject.Scene_Base.prototype.isAutosaveEnabled=function(){return false};external_window_namespaceObject.Scene_Title.prototype.create=function(){external_window_namespaceObject.Scene_Base.prototype.create.call(this)};external_window_namespaceObject.Scene_Title.prototype.start=function(){external_window_namespaceObject.Scene_Base.prototype.start.call(this);external_window_namespaceObject.SceneManager.clearStack();external_window_namespaceObject.DataManager.setupNewGame();const toload=window.client.toload();this._loading=toload.length;for(const[global,name,func]of toload){src_log("*",global,name);window.client.load(global,name,async data=>{src_log("&",global,name,data);let result=func(data);while(result instanceof Promise){result=await result}this.cbLoad()})}};external_window_namespaceObject.Scene_Title.prototype.isBusy=function(){return external_window_namespaceObject.Scene_Base.prototype.isBusy.call(this)};external_window_namespaceObject.Scene_Title.prototype.update=function(){external_window_namespaceObject.Scene_Base.prototype.update.call(this)};external_window_namespaceObject.Scene_Title.prototype.cbLoad=function(){this._loading-=1;if(this._loading>0){return}src_log("starting game");if(external_window_namespaceObject.$gameParty.isAllDead()||!external_window_namespaceObject.$gamePlayer.isTransferring()){src_log("revive");const mapId=external_window_namespaceObject.$dataSystem.startMapId;const x=external_window_namespaceObject.$dataSystem.startX;const y=external_window_namespaceObject.$dataSystem.startY;external_window_namespaceObject.$gamePlayer.reserveTransfer(mapId,x,y,2,0);external_window_namespaceObject.$gameParty.leader().recoverAll()}external_window_namespaceObject.SceneManager.goto(external_window_namespaceObject.Scene_Map)};window.client=new ClientImpl;external_window_namespaceObject.SceneManager.isGameActive=function(){return true};external_window_namespaceObject.Window_MenuCommand.prototype.isSaveEnabled=function(){return false};external_window_namespaceObject.Game_Interpreter.prototype.command354=function(){window.client.logout();return true};external_window_namespaceObject.Scene_GameEnd.prototype.commandToTitle=function(){this.fadeOutAll();window.client.logout()};external_window_namespaceObject.StorageManager.isLocalMode=function(){return false};external_window_namespaceObject.DataManager.isTitleSkip=function(){return false}})();
